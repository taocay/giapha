<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIA PHẢ HỌ LÊ</title>

<link rel="stylesheet" href="data/reset.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="Navigation/Navigation.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">	
<link rel="stylesheet" href="Ag-Grid-js\ag-grid.css">
<link rel="stylesheet" href="Ag-Grid-js\ag-theme-alpine.css">
<script src="Ag-Grid-js\enterprise31_2_1.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>


  <script src="D3-JS\d3.v7.min.js"></script>
    <!-- Canvg để vẽ SVG vào Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/3.0.10/umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oleo+Script&display=swap" rel="stylesheet">

<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">

<!-- Tagify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

<script>
  if (document.location.search.match(/type=embed/gi)) {
    window.parent.postMessage("resize", "*");
  }
</script>

<head>
<style>
html, body {
   overscroll-behavior: none;
}
/* suggested */
html, body {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}

body > .main-content {
  flex: 1;
}
* {
  box-sizing: border-box;
}
/*the container must be positioned relative:*/
.autocomplete {
  position: relative;
  display: inline-block;
}

input {
  border: 1px solid transparent;
  background-color: #f1f1f1;
  padding: 10px;
  font-size: 13px;
}

input[type=text] {
  background-color: #f1f1f1;
  width: 100%;
}

input[type=submit] {
  background-color: DodgerBlue;
  color: #fff;
  cursor: pointer;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}

/* End suggested */


.button {
  background-color: #fad7a0; /* #808b96 ; */
  border: none;
  color: #b22222;
  padding: 1px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  cursor: pointer;
  
}

.button1 {border-radius: 10em;}

.button:hover {
  background-color: #f39c12; /* #566573; */
  cursor: pointer;
}


/* Thêm cho Button */

.container {
    width: 98%;
    display: flex;
    justify-content: center; /* Căn giữa nội dung */
}

.button-container {
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 600px; /* Điều chỉnh độ rộng tối đa */
}

.home-button {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-right: auto; /* Căn trái */
}

.button-group {
    display: flex;
    gap: 10px; /* Khoảng cách giữa các nút */
    justify-content: center; /* Căn giữa */
    flex-grow: 1;
}

.button {
    width: 70px;
    height:28px;
    font-size: 13px;
    font-weight: bold;
    text-align: center;
}

.hometext {
    position: relative;
    display: inline-block;
    cursor: pointer;
}



/* End Thêm cho Button */

 body {
 font-family: Times New Roman;
 overscroll-behavior-y: contain;                 /* https://usefulangle.com/post/278/html-disable-pull-to-refresh-with-css */
    /* font-family: sans-serif; */
    -webkit-text-size-adjust: 100%;
    -ms-text-size-adjust: 100%
    color: #666;
    font: 90%/180% Arial, Helvetica, sans-serif;
    width:100%;
    max-width:100%;
    margin: 0 auto;
	
	background-image:white);
}

/* TABLE */
.HorizontalTable {
      width: 100%;
      overflow-x: scroll;
      overflow-y:hidden;
    }

.HorizontalTable {height: 20px; }
.Horizontal {
      width:15000px; /* Thay đổi mở rộng màn hình của thanh trượt */
      height: 20px;
    }


/* Footer */

.footer {
  width: 100%;
  font-family: sans-serif;
  box-sizing: border-box;
  margin-top: auto;
  display: flex;
  flex-direction: column;
}

.footer-top {
  background-color: white;
  color:#2e3b4e;
  text-align: center;
  padding: 5px 10px;
  font-weight: bold;
  font-size: 16px;
}

.footer-middle {
  background-color:#2e3b4e;
  padding: 5px 10px;
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  text-align: left;
  gap: 5px;
  color: white;
}

.footer-col {
  flex: 1 1 30%;
  min-width: 200px;
  margin: 0;
}

.footer-col.first {
  flex: 2 1 35%;
}

.footer-item {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  font-size: 14px;
  color: white;
  padding: 2px 0;
}

.footer-item i {
  color: #66ccff;
  font-size: 16px;
  min-width: 18px;
  margin-top: 2px;
}

.footer-item a {
  color: white;
  text-decoration: none;
}

.footer-bottom {
  background-color:#1c2735;
  padding: 2px 10px;
  text-align: center;
  font-size: 12px;
  line-height: 16px;
  font-weight: bold;
  color: white;
}

@media (max-width: 768px) {
  .footer-col,
  .footer-col first {
    width: 100%;
    text-align: left;
    margin: 2px 0;
    display: block;
  }

}

/* End Footer */


.input1 {border-radius: 12px;}

fieldset {

background: linear-gradient(to right, #fff8dc, #ffe4b5);

display: block;

left: 0;
max-width:100%;

}

fieldset:focus-within {
  background: linear-gradient(to right, #fff8dc, #ffe4b5);

}



legend{
width:250px;
height:28px;
text-align: center;
font-size: 15px; 
font-weight:  bold;
color: #b22222;
padding: 2px 2px ;

box-shadow: 0 0 0 2px #ddd;
font: time new roman;
 background-color:#fad7a0; /* #808b96; */
border-radius: 10em;
}






form .question {
  position: relative;
  padding: 10px 4px;
  display:inline-block;
}
form .question:first-of-type {
  padding-top: 0;
}
form .question:last-of-type {
  padding-bottom: 0;
}
form .question label {
  transform-origin: left center;
  color: #0e3753;
  font-weight: 700;
  letter-spacing: 0.01em;
  font-size: 14px;
  box-sizing: border-box;
  padding: 8px 17px;
  display: block;
  position: absolute;
  margin-top: -35px;
  z-index: 2;
  pointer-events: none;
}



	


@media (max-width: 380px) {
  .footer {
    font-size: 14px;
  }
  .footer .footer-left,
  .footer .footer-center,
  .footer .footer-right {
    display: block;
    width: 100%;
    margin-bottom: 40px;
    text-align: left;
  }
  .footer .footer-center i {
    margin-left: 3px;
  }

  .question .id {
	width:122px;
	min-height:40px;
	}
 .question .Colum2 {
	width:122px;
	min-height:40px;
	}
.question .Colum3 {
	width:122px;
	min-height:40px;
	}

.question .Colum4 {
	width:122px;
	min-height:40px;
	}
 .question .Colum5 {
	width:122px;
	min-height:40px;
	}
 .question .Colum6 {
	width:122px;
	min-height:40px;
	}
 .question .Colum7 {
	width:122px;
	min-height:40px;
	}
 .question .Colum8 {
	width:122px;
	min-height:40px;
	}
 .question .Colum9 {
	width:122px;
	min-height:40px;
	}
 .question .Colum10 {
	width:122px;
	min-height:40px;
	}
.question .Colum11 {
	width:122px;
	min-height:40px;
	}
 .question .Colum12 {
	width:122px;
	min-height:40px;
	}
 .question .Colum13 {
	width:122px;
	min-height:40px;
	}
 .question .Colum14 {
	width:122px;
	min-height:40px;
	}
 .question .Colum15 {
	width:122px;
	min-height:40px;
	}	

 .question .Colum16 {
	width:122px;
	min-height:40px;
	} 

.question .Colum17 {
	width:122px;
	min-height:40px;
	}

.question .Colum18 {
	width:122px;
	min-height:40px;
	}
 .question .Colum19 {
	width:122px;
	min-height:40px;
	}
 .question .Colum20 {
	width:122px;
	min-height:40px;
	}
 .question .Colum21 {
	width:122px;
	min-height:40px;
	}
 .question .Colum22 {
	width:122px;
	min-height:40px;
	}
 .question .Colum23 {
	width:122px;
	min-height:40px;
	}
 .question .Colum24 {
	width:122px;
	min-height:40px;
	}
.question .Colum25 {
	width:122px;
	min-height:40px;
	}
 .question .Colum26 {
	width:122px;
	min-height:40px;
	}
 .question .Colum27 {
	width:122px;
	min-height:40px;
	}
 .question .Colum28 {
	width:122px;
	min-height:40px;
	}
 .question .Colum29 {
	width:122px;
	min-height:40px;
	}	

 .question .Colum30 {
	width:122px;
	min-height:40px;
	} 	
 .question .Colum31 {
	width:122px;
	min-height:40px;
	}	
	
}


@media (max-width: 600px) {
  .footer {
    font-size: 14px;
  }
  .footer .footer-left,
  .footer .footer-center,
  .footer .footer-right {
    display: block;
    width: 100%;
    margin-bottom: 40px;
    text-align: left;
  }
  .footer .footer-center i {
    margin-left: 3px;
  }

.question .id {
	width:140px;
	min-height:40px;
	}
.question .Colum2 {
	width:140px;
	min-height:40px;
	}
.question .Colum3 {
	width:140px;
	min-height:40px;
	}

.question .Colum4 {
	width:140px;
	min-height:40px;
	}
 .question .Colum5 {
	width:140px;
	min-height:40px;
	}
 .question .Colum6 {
	width:140px;
	min-height:40px;
	}
 .question .Colum7 {
	width:140px;
	min-height:40px;
	}
 .question .Colum8 {
	width:140px;
	min-height:40px;
	}
 .question .Colum9 {
	width:140px;
	min-height:40px;
	}
 .question .Colum10 {
	width:140px;
	min-height:40px;
	}
.question .Colum11 {
	width:140px;
	min-height:40px;
	}
 .question .Colum12 {
	width:140px;
	min-height:40px;
	}
 .question .Colum13 {
	width:140px;
	min-height:40px;
	}
 .question .Colum14 {
	width:140px;
	min-height:40px;
	}
 .question .Colum15 {
	width:140px;
	min-height:40px;
	}	

 .question .Colum16 {
	width:140px;
	min-height:40px;
	} 

.question .Colum17 {
	width:140px;
	min-height:40px;
	}
.question .Colum18 {
	width:140px;
	min-height:40px;
	}
.question .Colum19 {
	width:140px;
	min-height:40px;
	}

.question .Colum20 {
	width:140px;
	min-height:40px;
	}
 .question .Colum21 {
	width:140px;
	min-height:40px;
	}
 .question .Colum22 {
	width:140px;
	min-height:40px;
	}
 .question .Colum23 {
	width:140px;
	min-height:40px;
	}
 .question .Colum24 {
	width:140px;
	min-height:40px;
	}
 .question .Colum25 {
	width:140px;
	min-height:40px;
	}
 .question .Colum26 {
	width:140px;
	min-height:40px;
	}
.question .Colum27 {
	width:140px;
	min-height:40px;
	}
 .question .Colum28 {
	width:140px;
	min-height:40px;
	}
 .question .Colum29 {
	width:140px;
	min-height:40px;
	}
 .question .Colum30 {
	width:140px;
	min-height:31px;
	}
 .question .Colum31 {
	width:140px;
	min-height:40px;
	}	
	
}


.popup {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 25%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.dialog-btn {
  background-color:#fad7a0; /* #808b96; */
  color:#b22222;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.dialog-btn:hover {
  background-color:#f39c12; /* #566573; */
  cursor: pointer;
}



#btn-show-dialog {
  background-color:#f39c12;
  border: none;
  color: #b22222;
  padding: 1px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 17px;
  margin: 3px 1px;
  cursor: pointer;
    height: 30px;
  width: 90px;
  font-weight: bold;
}

#btn-show-dialog {border-radius: 12px;}




.popup_time {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 25%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_time {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_time {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_time {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_time {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}



.popup_update {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_update {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_update {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_update {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_update {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.update-btn {
  background-color:#fad7a0; /* #808b96; */
  color: #b22222;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 5px;
  height: 30px;
  width: 30%;
}
.update-btn:hover {
  background-color: #f39c12; /* #566573; */
  cursor: pointer;
}


.popup_updateExcel {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_updateExcel {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_updateExcel {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_updateExcel {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_updateExcel {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.updateExcel-btn {
  background-color:#808b96;
  color: white;
  font-weight: 700;
  border: 1px solid #44B78B;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.updateExcel-btn:hover {
  background-color: #566573;
  cursor: pointer;
}

.popup_resultExcel {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 25%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_resultExcel {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_resultExcel {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_resultExcel {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_resultExcel {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}


.popup_ketnoi {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: relative;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_ketnoi {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

#confirm_ketnoi {
  position: absolute;
  top: 5px;
  right: 5px;
  background-color: #fad7a0;
  color: #b22222;
  font-weight: 600;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 20px;
  width: 20px;
  cursor: pointer;
}

@media (min-width: 768px) {
  .popup_ketnoi {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_ketnoi {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_ketnoi {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.ketnoi-btn {
  background-color:#808b96;
  color: white;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.ketnoi-btn:hover {
  background-color: #566573;
  cursor: pointer;
}


/* TRANS */

.popup_trans {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_trans {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_trans {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_trans {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_trans {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.trans-btn {
  background-color:#808b96;
  color: white;
  font-weight: 700;
  border: 1px solid #44B78B;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.trans-btn:hover {
  background-color:#566573;
  cursor: pointer;
}

/*END TRANS */


.popup_insert {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_insert {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_insert {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_insert {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_insert {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.insert-btn {
  background-color:#fad7a0; /* #808b96; */
  color: #b22222;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.insert-btn:hover {
  background-color:#f39c12; /* #566573; */
  cursor: pointer;
}

.popup_delete {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_delete {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_delete {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_delete {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_delete {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.delete-btn {
  background-color:#fad7a0; /* #808b96; */
  color: #b22222;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.delete-btn:hover {
  background-color:#f39c12; /* #566573; */
  cursor: pointer;
}


.popup_id {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 15%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_id {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_id {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_id {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_id {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}


.popup_result {
  width: 80%;
  padding: 15px;
  left: 0;
  margin-left: 5%;
  border: 1px solid #b22222;
  border-radius: 10px;
  color: #b22222;
  background: white;
  position: absolute;
  top: 25%;
  box-shadow: 5px 5px 5px #000;
  z-index: 10001;
  font-weight: 700;
  text-align: center;
}

.Thoat_result {
  position: fixed;
  width: 100%;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: transparent;
  z-index: 10000;
  display :none;
}

@media (min-width: 768px) {
  .popup_result {
    width: 66.66666666%;
    margin-left: 16.666666%;
  }
}
@media (min-width: 992px) {
  .popup_result {
    width: 80%;
    margin-left: 25%;
  }
}
@media (min-width: 1200px) {
  .popup_result {
    width: 33.33333%;
    margin-left: 33.33333%;
  }
}

.id-btn {
  background-color:#fad7a0; /* #808b96; */
  color: #b22222;
  font-weight: 700;
  border: 1px solid #b22222;
  border-radius: 10px;
  height: 30px;
  width: 30%;
}
.id-btn:hover {
  background-color: #f39c12; /*#566573; */
  cursor: pointer;
}


/* Lịch */

.datepicker-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  z-index: 999;
  display: none;
  padding: 4px;
  margin-top: 1px;
  font-size: 14px;
  line-height: 1.428571429;
  color: #333;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.176);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.176);
}

/* End Lịch */


/* Thay đổi */
.header img {
	margin-bottom:1px; /* Giảm khoảng cách dưới hình ảnh */
}

.header p {
	margin-top: 1px; /* Giảm khoảng cách trên đoạn văn */
	margin-bottom:1px; /* Giảm khoảng cách dưới đoạn văn */
}

.header button {
	margin-top:1px; /* Giảm khoảng cách trên nút */
}

/* Thay đổi question2 */
.question2 p {
    margin: 1px 0; /* Giảm khoảng cách giữa các phần tử p */
}

.question2 input {
    margin: 1px 1px; /* Giảm khoảng cách giữa các nút input */
}


.container div {
    margin-bottom: 1px; /* Giảm khoảng cách giữa các phần tử div */
}

.container textarea {
    margin-bottom: 1px; /* Giảm khoảng cách dưới ô textarea */
}

.container .pagination {
    margin-top: 1px; /* Giảm khoảng cách trên phần phân trang */
    margin-bottom: 1px; /* Giảm khoảng cách dưới phần phân trang */
}

.container button {
    margin-top: 1px; /* Giảm khoảng cách trên nút */
}

.container p {
    margin:5px 0; /* Giảm khoảng cách giữa các phần tử p */
}


/* Tô màu tìm kiếm */
#filterText {
    width: 120px;
    height: 23px;
    border-radius: 26px;
    border: 1px solid #b22222;
	color: #b22222;
	background: #fad7a0;
    padding: 1px;
    margin-bottom: 10px;
}
#count {
font-weight: bold;
}
.highlight {
    background-color: yellow;
}
/* End Tô màu tìm kiếm */

/* Kẻ chỉ dữ liệu */
.ag-theme-alpine .ag-cell, 
.ag-theme-alpine .ag-header-cell {
    border: 0.7px solid #ccc;
}
.ag-header {
    background-color: #f39c12; /* Màu xanh nhạt */
    /* Các thiết lập khác */
}

/* Đảm bảo phần phân trang luôn hiển thị ở giữa trang */
.ag-theme-alpine .ag-paging-panel {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            width: 100%;
            top: 0;
            left: 0;
            background: white;
            z-index: 1;
}

/* Căn chỉnh lưới bên dưới phân trang */
        .ag-theme-alpine .ag-root-wrapper {
            padding-top: 45px; /* Điều chỉnh cho phù hợp với chiều cao của phân trang */
        }

        /* Ẩn phần "to of" trong phân trang */
        .ag-theme-alpine .ag-paging-panel .ag-paging-row-summary-panel {
            display: none;
}

/* Tính năng thay đổi độ cao dòng */
.ag-row-resize-handle {
    position: absolute;
    width: 100%;
    height: 1.5px; /* Đổi chiều cao để phù hợp với thiết kế */
    cursor: row-resize;
    background-color: #f0f0f0; /* Màu nền của điều khiển kéo thả */
    z-index: 1;
    bottom: 0;
    left: 0;
}
/* End Tính năng thay đổi độ cao dòng */

/* Thay đổi độ cao Input filter */

.ag-input-wrapper input[type="text"] {
    height: 23px !important; /* Điều chỉnh độ cao mong muốn */
}
/* End Thay đổi độ cao Input filter */

/* Nút Reset */
        .reset-button {
            padding: 5px;
            border: none;
            border-radius: 5px;
            background-color:#fad7a0; /* #85929e; */
            color: #b22222;
            cursor: pointer;
            font-size: 12px; /* Điều chỉnh kích thước biểu tượng */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .reset-button:hover {
            background-color:#f39c12; /* #566573; */
        }

        .reset-button .fa {
            margin: 0; /* Đảm bảo không có khoảng cách xung quanh biểu tượng */
        }
/* End Nút Reset */	

/* End Kẻ chỉ dữ liệu */

/* Tiến trình tải dữ liệu */

.lds-spinner,
.lds-spinner div,
.lds-spinner div:after {
  box-sizing: border-box;
}
.lds-spinner {
  color: currentColor;
  display: inline-block;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 40px; /* giảm kích thước width */
  height: 40px; /* giảm kích thước height */
  z-index: 1000; /* Ensure spinner is on top */
}
.lds-spinner div {
  transform-origin: 20px 20px; /* giảm kích thước origin */
  animation: lds-spinner 1.2s linear infinite;
}
.lds-spinner div:after {
  content: " ";
  display: block;
  position: absolute;
  top: 1.6px; /* giảm kích thước top */
  left: 18.4px; /* giảm kích thước left */
  width: 3.2px; /* giảm kích thước width */
  height: 8.8px; /* giảm kích thước height */
  border-radius: 20%;
  background: currentColor;
}
.lds-spinner div:nth-child(1) { transform: rotate(0deg); animation-delay: -1.1s; }
.lds-spinner div:nth-child(2) { transform: rotate(30deg); animation-delay: -1s; }
.lds-spinner div:nth-child(3) { transform: rotate(60deg); animation-delay: -0.9s; }
.lds-spinner div:nth-child(4) { transform: rotate(90deg); animation-delay: -0.8s; }
.lds-spinner div:nth-child(5) { transform: rotate(120deg); animation-delay: -0.7s; }
.lds-spinner div:nth-child(6) { transform: rotate(150deg); animation-delay: -0.6s; }
.lds-spinner div:nth-child(7) { transform: rotate(180deg); animation-delay: -0.5s; }
.lds-spinner div:nth-child(8) { transform: rotate(210deg); animation-delay: -0.4s; }
.lds-spinner div:nth-child(9) { transform: rotate(240deg); animation-delay: -0.3s; }
.lds-spinner div:nth-child(10) { transform: rotate(270deg); animation-delay: -0.2s; }
.lds-spinner div:nth-child(11) { transform: rotate(300deg); animation-delay: -0.1s; }
.lds-spinner div:nth-child(12) { transform: rotate(330deg); animation-delay: 0s; }

@keyframes lds-spinner {
  0% { opacity: 1; }
  100% { opacity: 0; }
}


/* End Tiến trình tải dữ liệu */

/* Upload File */

#fileUpload {
    display: none;
}

.custom-file-upload {
    display: inline-flex; /* Thay đổi thành flexbox */
    background-color: #fad7a0;
    height: 23px;
    color: #b22222;
    padding: 2px 5px;
    border: 1px solid #f39c12;
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    transition: background-color 0.3s ease;

    /* Căn giữa nội dung theo chiều dọc và ngang */
    align-items: center;
    justify-content: center;
}


/* Hiệu ứng hover */
.custom-file-upload:hover {
    background-color: #fef5e7;
}

/* End Upload File */

/* wrap text row pin */
        .wrap-text-cell {
            white-space: normal !important; /* Đảm bảo ô có thể gói dòng */
        }
        
		/* Border màu cho các ô của hàng pin */
        .red-border-cell {
            border: 1px solid #c0392b !important;
        }

.ag-row-pinned .wrap-text-cell {
/*  font-size: 10px !important; */ /* Giảm kích thước chữ */
    line-height: 1.5 !important; /* Giảm khoảng cách giữa các dòng */
    padding: 2px 5px !important; /* Giảm padding trong ô */
}

		
/* End wrap text row pin */

/* Canh Icon Home, Tiêu đề, Edit */
.header-bar {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 30px 10px;
  height: 40px;
}

.home-button,
.edit-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
}

.hometext {
  font-size: 11px;
  /* color: #fad7a0; */  
  font-weight: bold;
  margin-top: 0px;
}


.home-button i {
  font-size: 22px;
  margin-top: 15px;
  /* color: #fad7a0; */   
}



.header-title {
  position: absolute;
  text-align: center;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2em;
  color: #2874a6;
  font-weight: bold;
  margin: auto;
  word-break: break-word; /* Đảm bảo không bị tràn chữ */
}

.action-group {
  display: flex;
  gap: 8px;
  align-items: center;
  border: 1px solid #008080;
  border-radius: 4px;
  padding: 2px 8px;
  background-color: white;
  width: fit-content;
  height: 40px;
}

.edit-button {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  color:#dc7633;
  font-size: 13px;
  gap: 1px;
}

.edit-button i {
  font-size: 14px;
  margin-top: 10px;
}

.edittext {
  font-size: 11px;
  margin-top: 1px;
  font-weight: bold;
  color:#b22222;
}

/* Menu Button Style */
#menuIconBtn {
  background-color: transparent;
  color:#dc7633;
  border: none;
  padding: 0;
  font-size: 13px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  transition: background 0.2s;
  gap: 1px;
}

#menuIconBtn:hover {
  background-color: rgba(0, 128, 128, 0.05);
}

.menu-icon {
  font-size: 17px;
}

.menu-text {
  font-size: 11px;
  margin-top: 1px;
  font-weight: bold;
  color:#b22222;
}

/* End Canh Icon Home, Tiêu đề, Edit */



/* Màu nền và chữ cho header */
.ag-theme-alpine .ag-header {
    background-color:#a9cce3; /* Màu nền cho header */
    font-weight: bold;
}

/* Màu nền và chữ cho floating filter (ô tìm kiếm) */
.ag-theme-alpine .ag-floating-filter {
    background-color: #d5d8dc; /* Màu nền cho ô tìm kiếm */
    color: black; /* Màu chữ cho ô tìm kiếm */
}

/* Màu nền cho các cột pinned với 20% vàng nhạt ở phía trên */
.ag-theme-alpine .ag-row-pinned .ag-cell {
    background: linear-gradient(180deg, #fbeee6,#d6eaf8, #ffffff 100%) !important; /* Xanh nhạt chiếm 20% phía trên, phần còn lại là màu trắng */
}

/* Loại bỏ hover cho pinned rows */
.ag-theme-alpine .ag-row-pinned:hover .ag-cell {
    background: linear-gradient(180deg, #fbeee6, #ffffff, #ffffff 100%) !important; /* Duy trì màu nền khi hover */
}

/* Loại bỏ hiệu ứng hover hoàn toàn trên pinned rows */
/* .ag-theme-alpine .ag-row-hover.ag-row-pinned { */
/*     pointer-events: none !important; */
/* } */



/* End Màu nền và chữ cho header */

/* Luôn hiển thị Munu trên header */
.ag-header-cell-menu-button {
    opacity: 1 !important;  /* Luôn hiển thị icon */
    visibility: visible !important;
    display: flex !important;
}


/* Thay đổi */

/* Chử hiệu ứng */

	@media (max-width: 768px) {
	  .text-effect {
		font-size: 27px !important;
	  }
	}

	.text-effect {
		color: #fff6a9;
		font-family: 'Dancing Script', cursive;
		font-size: 35px;
		font-weight: 600;
		text-align: center;
		text-transform: capitalize;
		position: relative;
		animation: animate 6s ease-in-out infinite;
		width: 100%;
		margin: 0;
		padding: 5px 0;
	}

	@keyframes animate {
		/* Nháy màu vàng */
		0%, 19%, 21%, 23%, 25% {
			color: #fff6a9;
			text-shadow:
				0 0 5px #ffa500,
				0 0 15px #ffa500,
				0 0 20px #ffa500,
				0 0 40px #ffa500,
				0 0 60px #ff0000,
				0 0 10px #ff8d00,
				0 0 98px #ff0000;
		}

		20%, 24% {
			/* color: #111; */
			color:#ffffff;
			text-shadow: none;
		}

		/* Nháy màu đỏ */
		55%, 57%, 59%, 61%, 63% {
			color:#CD5C5C;
			text-shadow:
				0 0 5px #ffffff,
				0 0 15px #ffffff,
				0 0 30px #ffffff,
				0 0 50px #ffffff;
		}

		56%, 58%, 60%, 62% {
			color: #111;
			text-shadow: none;
		}

		/* Kết thúc bằng màu đỏ*/
		100% {
			color:#CD5C5C;
			text-shadow:
				0 0 5px #ffffff,
				0 0 15px #ffffff,
				0 0 30px #ffffff,
				0 0 50px #ffffff;
		}
	}


	@media only screen and (max-width: 990px){
		.text-effect{ font-size: 100px; }
	}
	@media only screen and (max-width: 767px){
		.text-effect{ font-size: 80px; }
	}
	@media only screen and (max-width: 479px){
		.text-effect{ font-size: 60px; }
	}
	@media only screen and (max-width: 359px){
		.text-effect{ font-size: 45px; }
	}

/* End Chử hiệu ứng */



/* Chử hiệu ứng 2 */


.neon-container {
    width: 100%;
    height: 40px;
   
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    padding-top: 18px;
    perspective: 1000px;
}

.text {
    font-size: 30px;
    font-weight: 900;
    text-transform: uppercase;
    position: relative;
    color: rgba(255, 0, 0, 0.1);
    background-image: 
	url("D3-JS/Bg_Neon.jpg"),
	url("https://giadinhnongdan.com/img/cay-mai-vang-chung-tet-9.jpg");
    background-size: cover,cover;
    background-clip: text;
    -webkit-background-clip: text;
    animation: background-text-animation 90s linear infinite;
    transform-style: preserve-3d;
}

/* Đổ bóng 3D nhẹ sang phải */
.text::after {
    content: attr(data-text);
    position: absolute;
    top: 0;
    left: 0;
    color: #ff4d4d; /* đỏ tươi hơn */
    z-index: -1;
    transform: translateZ(-2px) translateX(2px) translateY(4px);
    opacity: 1.5; /* tăng để bóng rõ hơn */
    filter: blur(1.2px); /* tăng mờ giúp bóng mềm */

}


@keyframes background-text-animation {
    0% {
        background-position: left 0px top 50%;
    }
    50% {
        background-position: left 1500px top 50%;
    }
    100% {
        background-position: left 0px top 50%;
    }
}
/* End Chử hiệu ứng 2 */

/* Background header */

.slideshow {
  position: relative;
  width: 100%;
  height: 80px;
  overflow: hidden;
}

.slideshow ul {
  list-style: none;
  margin: 0;
  padding: 0;
  position: relative;
}

.slideshow li {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 80px;
}

.slideshow li span {
  position: absolute;
  width: 100%;
  height: 80px;
  background-size: cover;
  background-position: center center;
  opacity: 0;
  animation: imageAnimation 140s linear infinite;
}



.slideshow li:nth-child(1) span {
  background-image: url('D3-JS/sky.jpg');
  animation-delay: 0s;
}
.slideshow li:nth-child(2) span {
  background-image: url('D3-JS/1.png');
  animation-delay: 6s;
}
.slideshow li:nth-child(3) span {
  background-image: url('D3-JS/2.png');
  animation-delay: 12s;
}
.slideshow li:nth-child(4) span {
  background-image: url('D3-JS/3.jpg');
  animation-delay: 18s;
}
.slideshow li:nth-child(5) span {
  background-image: url('D3-JS/4.jpg');
  animation-delay: 24s;
}
.slideshow li:nth-child(6) span {
  background-image: url('D3-JS/5.jpg');
  animation-delay: 30s;
}
.slideshow li:nth-child(7) span {
  background-image: url('https://png.pngtree.com/png-clipart/20240806/original/pngtree-lotus-blossoms-blossom-abloom-s-photo-png-image_15716293.png');
  animation-delay: 36s;
}
.slideshow li:nth-child(8) span {
  background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhjLmOadt1i4kmXLBBOghJPXEflV_bhijLEujEjKfNQqBKKXA1AhudwnM1igd8MSmBnfRUsP01quhN-qXSYFliTHGrQny2wcHX32FwSO6ddkq2wDic8jyhrErQqapBK47DLp3Pt4ducfCJrLcEjMjEfO3jH9GjtCdR_uRxe2RINvxYve2mrzWA6w4u-bOk/s640-rw/(%20Anhpng.com%20)%20-%20TRANH%20S%C6%A0N%20TH%E1%BB%A6Y%20(12).jpg');
  animation-delay: 42s;
}
.slideshow li:nth-child(9) span {
  background-image: url('https://vj-prod-website-cms.s3.ap-southeast-1.amazonaws.com/depositphotos106506022xl-1736992243597.jpg');
  animation-delay: 48s;
}
.slideshow li:nth-child(10) span {
  background-image: url('https://s3-us-west-2.amazonaws.com/s.cdpn.io/203277/spring-slide.jpg');
  animation-delay: 54s;
}
.slideshow li:nth-child(11) span {
  background-image: url('https://cdnphoto.dantri.com.vn/aSixhHncWE3R7wB3KYFdfmTWzOg=/zoom/1200_630/2021/01/01/datsetnohoa-1-1609515734878.jpg');
  animation-delay: 60s;
}
.slideshow li:nth-child(12) span {
  background-image: url('https://vn-test-11.slatic.net/p/c04bf022c79c14d5e1f0ac89b46bab62.jpg');
  animation-delay: 66s;
}
.slideshow li:nth-child(13) span {
  background-image: url('https://png.pngtree.com/png-clipart/20240418/original/pngtree-flowers-minimal-color-element-png-image_14875770.png');
  animation-delay: 72s;
}
.slideshow li:nth-child(14) span {
  background-image: url('https://24hstore.vn/upload_images/images/hinh-nen-hoa-dao/hinh-nen-hoa-dao-4k.jpg');
  animation-delay: 78s;
}
.slideshow li:nth-child(15) span {
  background-image: url('https://hoanghamobile.com/tin-tuc/wp-content/uploads/2024/07/anh-hoa-dao.jpg');
  animation-delay: 84s;
}
.slideshow li:nth-child(16) span {
  background-image: url('https://cellphones.com.vn/sforum/wp-content/uploads/2023/10/hinh-nen-hoa-mai-tet-1.jpg');
  animation-delay: 90s;
}
.slideshow li:nth-child(17) span {
  background-image: url('https://khoinguonsangtao.vn/wp-content/uploads/2021/09/hinh-anh-gif.gif');
  animation-delay: 96s;
}
.slideshow li:nth-child(18) span {
  background-image: url('https://i.pinimg.com/originals/7a/ac/99/7aac999f34d23f7de7c2291410550bab.gif');
  animation-delay: 102s;
}



/* Keyframes chỉ cần đảm bảo mỗi ảnh hiện dần rồi tắt */
@keyframes imageAnimation {
  0%   { opacity: 0; }
  5%   { opacity: 0.7; }
  10%  { opacity: 1; }
  25%  { opacity: 1; }
  30%  { opacity: 0.7; }
  35%  { opacity: 0; }
  100% { opacity: 0; }
}


/* Background header */

/* Banner Header */

.banner {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  padding: 2px;
  box-sizing: border-box;
  width: 100%;
  margin-top: 0px;
  background: #fefcf7;
}

.box {
  width: 33%;
  background-color: #fffdf5;
  border-radius: 12px;
  padding: 5px;
  margin-bottom: 15px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  position: relative;
  border: 5px solid #d4af37;
  box-sizing: border-box;
  font-family: 'Georgia', serif;
  line-height: 1.2;
  border: 20px solid transparent;
  border-image: url('D3-JS/Khung.png') 30 round;
}

/* Viền vàng kép */
.box::before {
  content: "";
  position: absolute;
  top: -8px;
  left: -8px;
  right: -8px;
  bottom: -8px;
  border: 2px solid #f3e2a9;
  border-radius: 16px;
  z-index: -1;
}

.title {
  font-weight: bold;
  font-size: 18px;
  text-align: center;
  color: #b22222;
  margin-bottom: 10px;
  background: linear-gradient(to right, #fff8dc, #ffe4b5);
  border-radius: 5px;
  padding: 2px;
  font-family: 'Playfair Display', serif;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.content {
  font-size: 13px;
  text-align: justify;
  color: #333;
}

/* @media (max-width: 768px) { */
@media (max-width: 768px) and (orientation: portrait) {
  .box {
    width: 100%;
    padding: 5px;
    font-size: 13px;
	margin-top: 1px;
	margin-bottom: 1px;
  }

  .title {
    font-size: 16px;
	margin-top: 1px;
	margin-bottom: 5px;
  }

  .content {
    font-size: 13px;
    line-height: 1.2;
  }
}

/* Giao diện cho điện thoại ngang (iPhone 15 landscape) */
@media (max-width: 980px) and (orientation: landscape) {
  .box {
    width: 33%;
    padding: 5px;
    font-size: 13px;
	margin-top: 1px;
	margin-bottom: 1px;
  }

  .title {
    font-size: 16px;
	margin-top: 1px;
	margin-bottom: 5px;
  }

  .content {
    font-size: 13px;
    line-height: 1.2;
  }
}

/* End Banner Header */

/* Hiệu ứng node */
  .node.fade  { opacity: 0.12; }
  .link.fade  { opacity: 0.08; }

#btnRefresh {
  background:#f39c12;
  color: white;
  border: none;
  cursor: pointer;
}
#btnRefresh:hover {
  background-color: #b22222;
}  
  
 #familyTree {
 /*  background-image: url('https://gitiho.com/caches/p_medium_large//uploads/338054/images/image_32-hinh-nen-powerpoint-trong-dong.jpg');
  background-repeat: no-repeat; /* 
} 



/*  FORM & INPUT NHẬP DỮ LIỆU  /*

.btn-primary {
  border-color: rgba( 255, 255, 255, 0);
  background: #f1da36; /* Old browsers */

}
 
/* --- FORM CONTAINER --- */
#nhaplieu {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  padding: 20px 10px 10px;
  width: 79%;
  max-height: 90%;
  overflow-y: auto;
  border: 2px solid #ff4a56;
  box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
  z-index: 999;
  border-radius: 8px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  
}

form#nhaplieu {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  display: none;
}

/* --- FORM ITEM --- */
form .nhaplieu {
  position: relative;
  padding: 5px 0 5px; /* giảm khoảng cách hàng */
}

/* --- INPUT / TEXTAREA / SELECT --- */
form .nhaplieu textarea,
form .nhaplieu input,
form .nhaplieu select {
  width: 200px;
  padding: 2px 6px;
  border: 1px solid #ff4a56;
  font-size: 12px;
  font-weight: 100;
  letter-spacing: 0.01em;
  color: #000;
  background: none;
  height: 28px;
  line-height: 18px;
  box-sizing: border-box;
  resize: none;
  appearance: none;
}


/* --- LABEL chung --- */
form .nhaplieu label {
  position: absolute;
  left: 50%;                        /* Canh giữa theo chiều ngang */
  top: 3px;                           /* Cạnh trên của form field */
  transform: translate(-50%, -50%); /* Dịch lên giữa đường viền trên */
  
  color: #888;
  font-size: 12px;
  font-weight: 500;
  background: white;
  padding: 0 6px;
  pointer-events: none;
  transition: all 0.2s ease-in-out;
}


/* --- Khi focus hoặc có nội dung thì label nổi lên --- */
form .nhaplieu textarea:focus ~ label,
form .nhaplieu textarea:not(:placeholder-shown) ~ label,
form .nhaplieu input:focus ~ label,
form .nhaplieu input:not(:placeholder-shown) ~ label,
form .nhaplieu textarea:focus ~ label,
form .nhaplieu select:not([value=""]) ~ label {
  left: 50%;                        /* Canh giữa theo chiều ngang */
  top: -3px;                           /* Cạnh trên của form field */
  transform: translate(-50%, -50%); /* Dịch lên giữa đường viền trên */
  font-size: 11px;
  color: #ff4a56;
  background: white;
}

form .nhaplieu textarea:focus,
form .nhaplieu input:focus,
form .nhaplieu select:focus {
  outline: none;              /* Bỏ viền xanh */
  box-shadow: none;           /* Bỏ hiệu ứng đổ bóng khi focus */
  border-color: #ff4a56;      /* Giữ hoặc đặt lại viền mong muốn */
}

/* --- Ẩn thanh cuộn textarea --- */
textarea {
  min-height: 30px;
  height: 30px;
  font-size: 12px;
  line-height: 16px;
  padding: 6px 6px;
  border: 1px solid #ff4a56;
  box-sizing: border-box;
  resize: none;
  overflow-y: hidden;
}
/* --- End Ẩn thanh cuộn textarea --- */

/* Colum_2 */	
#Colum_2 {
  width: 200px;
  height: 30px;
}	
/* End Colum_2 */


/* SELECT_3 */

.dropdown-wrapper {
  position: relative;
}

.dropdown-list {
  position: absolute;
  top: 100%; /* đặt dropdown ngay bên dưới input */
}


/* END SELECT_3 */


/* SELECT_4 */

.gender-wrapper {
  position: relative;
  width: 100%;
}

#Colum_4 {
  width: 200px;
  height: 30px;
  font-size: 11px;
  border: 1px solid #ff4a56;
  padding: 2px;
  box-sizing: border-box;
  background: #fff;
  cursor: pointer;
}

/* Dropdown */
#dropdown4 {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background: white;
  border: 1px solid #ccc;
  z-index: 999;
  font-size: 11px;
}

#dropdown4 div {
  padding: 2px 4px;
  border-bottom: 1px solid #fff;
  cursor: pointer;
  background-color: #aed6f1;
  line-height: 16px;
}

#dropdown4 div:nth-child(even) {
  background-color: #aed6f1;
}

#dropdown4 div:hover {
  background-color: #cceeff;
}


/* END SELECT_4 */

/* SELECT_6 */

/* --- TAGIFY (Colum_6) --- */
.nhaplieu.tagify-wrapper label {
  position: absolute;
  left: 50%;                        /* Canh giữa theo chiều ngang */
  top: 1px;                           /* Cạnh trên của form field */
  font-size: 11px;
  background: #fff;
  padding: 0 6px;
  color: #888;
  font-weight: 500;
  z-index: 3;
  transition: all 0.2s ease-in-out;
}

/* ✅ TAGIFY CHUẨN HOÁ (Colum_6) */

#Colum_6.tagify,
.tagify {
  width: 200px;
  font-size: 11px;
  box-sizing: border-box;
  border: 1px solid #ff4a56;
  background-color: white;
  display: flex !important;
  flex-wrap: wrap;
  align-items: flex-start;

  gap: 2px;
  overflow: visible;
}

/* ✅ Input Tagify */
.tagify__input {
  order: -1;
  width: 100% !important;
  height: 29px !important;
  line-height: 25px !important;
 
  margin: 0 !important;
  box-sizing: border-box;
  flex: 0 0 auto;
  border-bottom: 1px solid #ccc;/* ✅ Viền dưới */ 
}

/* ✅ Tag trong Colum_6 */
.tagify__tag {
  width: 200px;                   /* ✅ Fix chiều rộng */
  height: 16px;
  line-height: 16px;
  padding: 0 2px;
  font-size: 11px;
  background: #f5f5f5;
  border-radius: 2px;
  display: flex;
  align-items: center;
  box-sizing: border-box;
  margin: 1px 0;
}

/* Dropdown gợi ý */
.tagify__dropdown__item {
  font-size: 11px;
}

/* ✅ Khi revert về textarea */
textarea#Colum_6 {
  min-height: 30px;
  height: 30px;
  font-size: 11px;
  padding: 1px 6px;
  box-sizing: border-box;
  line-height: 30px;
  resize: none;
}


/* ✅ SELECT_7 */
.tags-wrapper {
  position: relative;
  width: 200px;
}

/* Label cố định */
.label-fixed {
  position: absolute;
  left: 50%;
  top: -8px;
  font-size: 11px;
  color: #888;
  pointer-events: none;
  z-index: 1;
  background: transparent;
  transform: translateX(-50%);
}

/* Khi có nội dung */
.tags-wrapper.has-content .label-fixed {
  top: -8px;
  color: #ff4a56;
}

/* Focus hoặc có nội dung => đẩy label lên */
#Colum_7:focus ~ .label-fixed,
#Colum_7:not(:placeholder-shown) ~ .label-fixed,
.tags-wrapper:has(#Colum_7:focus) .label-fixed,
.tags-wrapper:has(#Colum_7:not(:placeholder-shown)) .label-fixed {
  top: -7px;
  color: #ff4a56;
}

/* ✅ Container chứa tags + input */
.tags-container {
  width: 200px;
  min-height: 30px;
  max-height: auto;
  overflow-y: auto;
  overflow-x: hidden;
  position: relative;
  border: 1px solid #ff4a56;
  border-radius: 2px;
  background-color: #fff;
  font-size: 11px;
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  padding: 2px;
  gap: 3px;
  box-sizing: border-box;
  /* padding-bottom: 5px; */
}

/* ✅ Tag trong Colum_7 */
.tags-container .tag {
  width: 200px;                  /* ✅ Fix chiều rộng */
  height: 16px;
  line-height: 16px;
  padding: 0 2px;
  font-size: 11px;
  background-color: #eaecee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-radius: 2px;
  box-sizing: border-box;
  flex: 0 0 auto;
  margin: 0;
}

.tags-container .tag span {
  margin-left: 2px;
  cursor: pointer;
}

/* ✅ Input trong Colum_7 */
#Colum_7 {
  order: -1;
  font-size: 11px;
  border: none;
  border-bottom: 1.5px solid #ccc;
  outline: none;
  width: 100%;
  background: transparent;
  min-height: 16px;
  line-height: 16px;
  
  box-sizing: border-box;
  margin: 0;
  flex: 1 1 auto;
}


/* ✅ Dropdown */
.dropdown-list {
  position: absolute;
  top: calc(100% + 2px);
  left: 0;
  width: 100%;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  max-height: 140px;
  overflow-y: auto;
  font-size: 11px;
  z-index: 999;
  display: none;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.dropdown-list div {
  padding: 1px 2px;
  line-height: 16px;
  cursor: pointer;
  border-bottom: 1px solid #fff;
}

.tags-container .tag span {
  margin-right: 15px;  /* ✅ Dịch nút x vào bên trái */
}
.tags-container .tag .tag-close {
  font-size: 16px;   /* ✅ Tăng size nút × */
  cursor: pointer;
  margin-left: 2px;
  margin-right: 6px;
  line-height: 16px;
}
.dropdown-list div:nth-child(odd) {
  background-color: #aed6f1;

}
.dropdown-list div:nth-child(even) {
  background-color: #d4eaf9;
}

/* END SELECT_7 */



/* BUTTON FORM */
.form-buttons {
  display: flex;
  justify-content: center;  /* Căn giữa nút theo chiều ngang */
  align-items: center;
  gap: 20px;                /* Khoảng cách giữa 2 nút */
  margin-top: 5px;
  margin-left: auto;
  margin-right: auto;
  width: 100%;
}

.form-buttons button {
  padding: 8px 20px;
  font-size: 14px;
  border-radius: 5px;
  cursor: pointer;
  border: none;
  background-color: #ff4a56;
  color: white;
  transition: background 0.3s;
}

.form-buttons button:hover {
  background-color: #e03c48;
}
/* END BUTTON FORM */



/* @media (max-width: 768px) { */

@media (max-width: 768px) and (orientation: portrait) {
  #nhaplieu {
    width: 100%;
    display: flex;
    flex-wrap: wrap;
    /* justify-content: space-between; */
    justify-content: center;                 /* ⭐ Căn giữa các cột */
  }

  form .nhaplieu {
    width: 48%; /* chia đôi, chừa khoảng cách */
    margin-bottom: 8px;
    position: relative;
  }

  form .nhaplieu textarea {
    width: 100%; /* chiếm trọn khối .nhaplieu */
  }
  #Colum_2 {
    width: 100%;
  }
/* ✅ Colum_6 Giữ input 100% */
#Colum_6,
.tagify {
  width: 100% !important;
  max-width: 100%;
  box-sizing: border-box;
}

/* Container các tag không vượt quá input */
.tagify__input,
.tags-container {
  max-width: 100%;
  display: flex;
  flex-wrap: wrap;
  overflow-x: auto;
}

/* Từng tag co giãn hợp lý */
.tags-container .tag,
.tagify__tag {
  max-width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  box-sizing: border-box;
  margin-right: 6px;
}

  /* Nhản Colum_6 100% */	
 form .nhaplieu.tagify-wrapper {
  width: 47%;               /* ✅ Cho chiếm toàn bộ chiều ngang */
  white-space: nowrap;
 }

 
/* ✅ Select_7 cũng chiếm 100% */	
  .tags-wrapper,
  .tags-container,
  #Colum_7,
  #dropdown7 {
    width: 100% !important;
  }

  
  /* ✅ Select_4 cũng chiếm 100% */
  .gender-wrapper {
    width: 100%;
  }
  #Colum_4 {
    width: 100%;
  }
  #dropdown4 {
    width: 100%;
  }

  
  .form-buttons {
    width: 100%;
    text-align: center;
    margin-top: 10px;
  }

  .form-buttons button {
    padding: 4px 10px;
    font-size: 12px;
  }
}
/*  điện thoại xoay ngang  */
@media (max-width: 980px) and (orientation: landscape) {
  #nhaplieu {
    width: 88%;
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* ✅ Căn giữa các cột */
  }

  form .nhaplieu {
    width: 40%;              /* ✅ Chia 2 cột đẹp khi ngang */
    margin-bottom: 8px;
    position: relative;
  }

  form .nhaplieu textarea,
  form .nhaplieu input {
    width: 100%;
  }


  /* Colum_2 ép full width */
  #Colum_2 {
    width: 100% !important;
  }

  /* Giới tính Colum_4 ép full */
  .gender-wrapper,
  #Colum_4,
  #dropdown4 {
    width: 100% !important;
  }

/* Các phần đặc biệt như dropdowns, tagify, ... */
 
#Colum_6.tagify,
.tagify,
.tagify__tag {
  width: 100% !important;      /* ✅ Thay vì 200px */
 }	
#Colum_6 {
  width: 100% !important;
}
/* Colum_7 ép toàn bộ nhánh Tagify */
.tags-wrapper,
.tags-container,
#Colum_7,
#dropdown7 {
  width: 100% !important;
  box-sizing: border-box;
}

/* 👉 Mỗi tag trong mối liên hệ cũng phải full width */
.tags-container .tag {
  width: 100% !important;
  box-sizing: border-box;
  justify-content: space-between;  /* để span tên + nút × tách ra 2 đầu */
}

  .form-buttons {
    width: 100%;
    text-align: center;
    margin-top: 10px;
  }

  .form-buttons button {
    padding: 6px 12px;
    font-size: 14px;
  }
}


/*  End điện thoại xoay ngang  */

/*  END FORM NHẬP DỮ LIỆU  */



</style>

</head>


<body oncontextmenu="return false">

<!-- Thay đổi  -->
<div class="main-content">

	<div class="slideshow">
	<ul>
	  <li><span></span></li> <!-- 1 -->
	  <li><span></span></li> <!-- 2 -->
	  <li><span></span></li> <!-- 3 -->
	  <li><span></span></li> <!-- 4 -->
	  <li><span></span></li> <!-- 5 -->
	  <li><span></span></li> <!-- 6 -->
	  <li><span></span></li> <!-- 7 -->
	  <li><span></span></li> <!-- 8 -->
	  <li><span></span></li> <!-- 9 -->
	  <li><span></span></li> <!-- 10 -->
	  <li><span></span></li> <!-- 11 -->
	  <li><span></span></li> <!-- 12 -->
	  <li><span></span></li> <!-- 13 -->
	  <li><span></span></li> <!-- 14 -->
	  <li><span></span></li> <!-- 15 -->
	  <li><span></span></li> <!-- 16 -->
	  <li><span></span></li> <!-- 17 -->
	  <li><span></span></li> <!-- 18 -->
	</ul>

	  
	  <div class="neon-container">
		<div class="neon">
		  <span class="text" data-text="Gia phả">Gia phả</span>
		</div>
	  </div>
	 
	<div class="text-effect"><span id="header1" value=""></span></div>
	</div>
   
</div>

<div class="banner">
  <div class="box" id = "box1" hidden>
    <div class="title" id="header2" value=""></div>
    <div class="content" id="header3" value=""></div>
  </div>
  <div class="box" id = "box2" hidden>
    <div class="title" id="header4" value=""></div>
    <div class="content" id="header5" value=""></div>
  </div>
  <div class="box" id = "box3" hidden>
    <div class="title" id="header6" value=""></div>
    <div class="content" id="header7" value=""></div>
  </div>
</div>

<div class="content" id="header8" value="" hidden></div>

<div class="header-bar">
  <!-- Nút Home (trái) -->
  <span id="btn-show-Thoat" class="home-button">
    <i class="fas fa-home" style="font-size: 25px; color: #dc7633;"></i>
    <span class="hometext" style="font-size:11px; color:#b22222; font-weight: bold;">Home</span>
  </span>

  <!-- Nút Edit (phải) -->
  
<div class="menu-container" style="position: relative; display: flex; align-items: center; gap: 8px;">
  
  <!-- Nút Edit -->
<div class="action-group">

  <button id="menuIconBtn">
    <div class="menu-icon">☰</div>
    <div class="menu-text">Export</div>
  </button>

	<div id="menuContent" class="menu-content" style="display: none;position: absolute;right: 0;background-color: white; border: 1px solid #ccc; box-shadow: 0px 4px 8px rgba(0,0,0,0.2); z-index: 999; min-width: 140px;">
	<button id="btnPNG" style="width: 100%; padding: 8px; border: none; background: none; text-align: left;">
	  📸 Xuất PNG
	</button>

	<button id="btnPDF" style="width: 100%;padding: 8px;border: none;background: none;text-align: left;border-top: 1px solid #ddd; /* đường phân cách */">
	  📄 Xuất PDF
	</button>
	</div>  

  <span id="btn-show-updateOn" class="edit-button">
    <i class="fa fa-edit"></i>
    <span class="edittext">Edit</span>
  </span>
	
</div>


</div>

  
  <!-- Tiêu đề (giữa) -->
  <!-- <p class="header-title">GIA PHẢ HỌ LÊ - PHÁI 3 - CHI 1</p> -->

</div>


            <div id="spinner" class="lds-spinner" style="display: none;">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>

<div class="Thoat" id="dialog-container">
  <div class="popup">
    <p>Bạn có muốn Thoát không ?</p>
    <div class="text-right">
      <button class="dialog-btn btn-cancel" id="cancel">Cancel</button>
      <button class="dialog-btn btn-primary" id="confirm">OK</button>
    </div>
  </div>
</div>
<p id="testText"></p>

<div class="Thoat_time" id="dialog_time">
  <div class="popup_time">
    <p>Bạn phải Đăng nhập lại !!</p>
    <div class="text-right">
      <button class="dialog-btn btn-primary" id="confirm_time">OK</button>
    </div>
  </div>
</div>

<div class="Thoat_update" id="update-container">
  <div class="popup_update">
	<p type = "text" id="id_Up" value=""></p>
    <div class="text-right">
      <button class="update-btn btn-cancel" id="cancel_update">Cancel</button>
      <button class="update-btn btn-primary" id="confirm_update">OK</button>
    </div>
  </div>
</div>


<div class="Thoat_insert" id="insert-container">
  <div class="popup_insert">
	<p type = "text" id="id_Ins" value=""></p>
    <div class="text-right">
      <button class="insert-btn btn-cancel" id="cancel_insert">Cancel</button>
      <button class="insert-btn btn-primary" id="confirm_insert">OK</button>
    </div>
  </div>
</div>

<div class="Thoat_delete" id="delete-container">
  <div class="popup_delete">
	<p type = "text" id="id_Del" value=""></p>
    <div class="text-right">
      <button class="delete-btn btn-cancel" id="cancel_delete">Cancel</button>
      <button class="delete-btn btn-primary" id="confirm_delete">OK</button>
    </div>
  </div>
</div>

<div class="Thoat_id" id="id-container">
  <div class="popup_id">
    <p type = "text" id="id_alert" value=""></p>
    <div class="text-right">
      <button class="id-btn btn-primary" id="confirm_id">OK</button>
    </div>
  </div>
</div>


<div class="Thoat_result" id="dialog_result">
  <div class="popup_result">
    <p id="id_result" value=""></p>
    <div id="id_result1" class="text-right">
      <button class="dialog-btn btn-primary" id="confirm_result1">OK</button>
    </div>

    <div id="id_result2" class="text-right">
	  <button class="dialog-btn btn-primary" id="confirm_result2">OK</button>
    </div>	

    <div id="id_result3" class="text-right">
	  <button class="dialog-btn btn-primary" id="confirm_result3">OK</button>
    </div>
	
    <div id="id_result4" class="text-right">
	  <button class="dialog-btn btn-primary" id="confirm_result4">OK</button>
    </div>
	
 </div>
</div>


<div class="Thoat_updateExcel" id="updateExcel-container">
  <div class="popup_updateExcel">
	<p type = "text" id="id_UpExcel" value=""></p>
    <div class="text-right">
      <button class="update-btn btn-cancel" id="cancel_updateExcel">Cancel</button>
      <button class="update-btn btn-primary" id="confirm_updateExcel">OK</button>
    </div>
  </div>
</div>

<div class="Thoat_resultExcel" id="dialog_resultExcel">
  <div class="popup_result">
    <p id="id_resultExcel_1" value=""></p>
    <div class="text-right">
      <button class="dialog-btn btn-primary" id="confirm_resultExcel">OK</button>
    </div>	
 </div>
</div>


<div class="Thoat_ketnoi" id="dialog_ketnoi">
  <div class="popup_ketnoi">
    <p id="id_ketnoi" style="white-space: pre-line;"></p>
    <div class="text-right">
      <button class="dialog-btn btn-primary" id="confirm_ketnoi">X</button>
    </div>
  </div>
</div>


<!-- <div id="input" hidden readonly>  -->
<div id="input" hidden readonly>
	<div align="right"><input class="input1"  name ="capnhatgiaphachi" id="capnhatgiaphachi" style="width:100px; height:26px; text-align: center; margin-right:40px; font-weight: bold; color: #ff0000" value="" ></div>
    <textarea id="id"></textarea>
</div>

<!-- FORM NHẬP DỮ LIỆU -->
<input type="button" class="button button1" id="showFormBtn" value="Hiện Form"/>


<form id="nhaplieu"> 

	<button type="button" id="closeForm" style="position: absolute; top: 10px; right: 10px; font-size: 20px; background: none; border: none; cursor: pointer;">&times;</button>	
	
		  <h3 style="width: 100%; text-align: center; margin-bottom: 20px;">Form nhập dữ liệu Gia phả</h3>
		  

			  <div class="nhaplieu">
				<textarea id="ID" placeholder=" "></textarea>
				<label>Số TT</label>
			  </div>
			  
			<div class="nhaplieu" style="position: relative;">
			  <input type="number" id="Colum_2" min="0" placeholder="" />
			  <label for="Colum_2">Nhập đời thứ</label>
			</div>
			
			<div class="nhaplieu">
			  <div class="dropdown-wrapper">
				<input type="text" id="Colum_3" placeholder=" " />
				<label for="Colum_3">Họ và tên</label>
				<div class="dropdown-list" id="dropdown3"></div>
			  </div>
			</div>

			
			<div class="nhaplieu">
			  <div class="gender-wrapper">
				<input type="text" id="Colum_4" placeholder=" " readonly />
				<label for="Colum_4">Giới tính</label>
				<div class="dropdown-list" id="dropdown4">
				  <div>Nam</div>
				  <div>Nữ</div>
				</div>
			  </div>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_5" placeholder=" "></textarea>
			  <label>Gán id</label>
			</div>

			<div class="nhaplieu tagify-wrapper">
			  <textarea id="Colum_6" placeholder="Chọn người liên hệ"></textarea>
			  <label for="Colum_6">Người liên hệ..</label>
			</div>


			<div class="nhaplieu">
			  <div class="tags-wrapper">
				<label for="Colum_7" class="label-fixed">Mối liên hệ</label> <!-- Label ra ngoài -->
				<div class="tags-container" id="tagInput7">
				  <input type="text" id="Colum_7" placeholder="Mối liên hệ.." readonly />
				</div>
				<div class="dropdown-list" id="dropdown7">

				</div>
			  </div>
			</div>




			<div class="nhaplieu">
			  <textarea id="Colum_8" placeholder=" "></textarea>
			  <label>Vị trí node</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_9" placeholder=" "></textarea>
			  <label>Ngày sinh</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_10" placeholder=" "></textarea>
			  <label>Quê quán</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_11" placeholder=" "></textarea>
			  <label>Kết hôn</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_12" placeholder=" "></textarea>
			  <label>Con</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_13" placeholder=" "></textarea>
			  <label>Thông tin</label>
			</div>

			<div class="nhaplieu">
			  <textarea id="Colum_14" placeholder=" "></textarea>
			  <label>Link avatar</label>
			</div>
			
		  <div class="form-buttons">
		    <button type="submit" id="confirmUpd">Cập nhật</button>
		    <button type="submit" id="confirmDel">Xóa</button>			
			<button type="button" id="cancelBtn">Thoát</button>
			
		  </div>
</form>

 
<div class="question2" align="center" hidden readonly>
<input type = "text" id="ngay"  ></input>
<input type = "text" id="ngay2" value=""  ></input>

	<p align="center" id="re" style="font-size: 1.2em; color: red; font-weight: bold" ></p>
</div>

<div id="textMeasurer" style="
  visibility: hidden;
  position: absolute;
  top: -9999px;
  left: -9999px;
  white-space: pre-wrap;
  word-wrap: break-word;
  padding: 0;
  line-height: 1.5;
  width: auto;
"></div>


<div id="update" hidden><div>
<form>
 <textarea id="output" style="width: 100%; height: 100px;"  hidden readonly></textarea>
		
<!-- Thanh trượt  -->		
<div class="HorizontalTable">
<div class="Horizontal"></div>
</div>
<!-- End Thanh trượt  -->

<fieldset style="margin-top: 10px;">
    <legend id="legend" align="center"></legend>
            <!-- Nội dung của bạn trong phần này -->


    <div class="container">
        <div class="button-container">
            <!-- Các nút khác (căn giữa) -->
            <div class="button-group">	
				<input type="button" class="button button1" id="btn-show-update" value="Cập nhật"/>
                <input type="button" class="button button1" id="btn-show-insert" value="Nhập mới"/>
                <input type="button" class="button button1" id="btn-show-delete" value="Xóa"/>
            </div>
        </div>
    </div>
</fieldset>

</form>



</p>
<div class="form-group" align="center">
<input type="text" id="filterText" oninput="externalFilterChanged()" placeholder="Tìm kiếm...">
<span id="count"></span>&nbsp;

     <button id="resetFilterButton" class="reset-button">
        <i class="fa fa-refresh" aria-hidden="true"></i>
    </button> 

&nbsp;<label style="color: #b22222; background: #fad7a0; border: 1px solid #f39c12;"for="fileUpload" class="custom-file-upload">Browse</label>
<input type="file" id="fileUpload" />
&nbsp;<button style="color: #b22222; background: #fad7a0; border: 1px solid #f39c12;" onclick="insertgiaphachiExcel_value()">Up File</button>


&nbsp;  <select id="exp" name="Excel" style="color: #b22222; background: #fad7a0; border: 1px solid #f39c12;">
    <option selected="selected" value="Excel" disabled="disabled" >Xuất Excel</option>
    <option value="exp1">Excel opt</option>
    <option value="exp2">Excel full</option>
	<option value="exp3">Mẫu Upload</option>
  </select>	
</div>
		
</div>

<div id="showData" class="ag-theme-alpine" style="height: 700px; width: 100%;"></div>
<div id="loader"></div>

</div>

<div id="chartContainer" style="position: relative;">
  <button id="btnRefresh" style="position: absolute; top: 5px; left: 5px; z-index: 10;">🔄</button>
	<!-- VẼ SƠ ĐỒ D3.JS -->  
	<div id="chart-container" style="width: 100%; height: auto; border: 1px solid #ccc; overflow-x: auto;">
	  <svg id="familyTree" height="100%"></svg>
	</div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>

<script src="Export_Excel_Color/Export_Excel_Color.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script src="LinkGG.js"></script>

<!-- Lịch củ --------->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.vi.min.js"></script>
<!-- End Lịch củ --------->

<!-- Lịch Ag-grid --------->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<!-- End Lịch Ag-grid --------->




<script>
//https://stackoverflow.com/questions/8100770/auto-scaling-inputtype-text-to-width-of-value
function resizeInput() {
    $(this).attr('size', $(this).val().length);
}

$('input[type="text"]')
    // event handler
    .keyup(resizeInput)
    // resize on page load
    .each(resizeInput);
	
	
	
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
})()	


	
</script>


<script>



</script>

<script type="text/javascript">//<![CDATA[
//---ÔK--------
window.onload = function(){

		//===Tạo Colum2 đến Colum67 Textarea====
		const container = document.getElementById('input'); // container là <div id="input">
		let rowDiv = document.createElement('div'); // dòng đầu tiên
		for (let i = 2; i <= 24; i++) {
		  const textarea = document.createElement('textarea');
		  textarea.id = 'Colum' + i;
		  textarea.style.height = '30px';
		  textarea.style.margin = '2px'; // thêm khoảng cách nhỏ
		  rowDiv.appendChild(textarea);

		  // Nếu đã đủ 24 textarea, thì thêm dòng vào container và bắt đầu dòng mới
		  if ((i - 1) % 24 === 0) {
			container.appendChild(rowDiv);
			rowDiv = document.createElement('div'); // tạo dòng mới
		  }
		}
		// Đừng quên thêm dòng cuối cùng nếu còn textarea
		if (rowDiv.children.length > 0) {
		  container.appendChild(rowDiv);
		}
		//===End Tạo Colum2 đến Colum67 Textarea====


	document.addEventListener('contextmenu', event => event.preventDefault());
	history.pushState(null, null, document.URL);
	window.addEventListener('popstate', function () {
		history.pushState(null, null, document.URL);
	});
	window.history.replaceState('','','/'); 
};
!function(n){"use strict";n.fn.idle=function(e){var t,i,o={idle:6e4,events:"mousemove keydown mousedown touchstart",onIdle:function(){},onActive:function(){},onHide:function(){},onShow:function(){},keepTracking:!0,startAtIdle:!1,recurIdleCall:!1},c=e.startAtIdle||!1,d=!e.startAtIdle||!0,l=n.extend({},o,e),u=null;return n(this).on("idle:stop",{},function(){n(this).off(l.events),l.keepTracking=!1,t(u,l)}),t=function(n,e){return c&&(e.onActive.call(),c=!1),clearTimeout(n),e.keepTracking?i(e):void 0},i=function(n){var e,t=n.recurIdleCall?setInterval:setTimeout;return e=t(function(){c=!0,n.onIdle.call()},n.idle)},this.each(function(){u=i(l),n(this).on(l.events,function(){u=t(u,l)}),(l.onShow||l.onHide)&&n(document).on("visibilitychange webkitvisibilitychange mozvisibilitychange msvisibilitychange",function(){document.hidden||document.webkitHidden||document.mozHidden||document.msHidden?d&&(d=!1,l.onHide.call()):d||(d=!0,l.onShow.call())})})}}(jQuery);

$(document).idle({
  onIdle: function(){
	Search_dialog_time();
  },
  //idle: 1800000
  idle: 3600000
})
//]]>


var Thoat_timeme = document.getElementById("dialog_time");
var Thoatme = document.getElementById("testText");
function Search_dialog_time(){
if (document.getElementById("dialog_time")==null || document.getElementById("testText")==null) {
close();
} else {
show_dialog_time();
}
}


function show_dialog_time() {
    Thoat_timeme.style.display = "block";}
document.getElementById("confirm_time").onclick = function(){Thoatconfirm_value()};

// Thoát
document.getElementById("btn-show-Thoat").onclick = function(){show_dialog()};
var Thoatme = document.getElementById("dialog-container");

function show_dialog() {
    Thoatme.style.display = "block";
}

document.getElementById("confirm").onclick = function(){Thoatconfirm_value()};

function Thoatconfirm_value() {	
 //alert("Thoát trang");
	var ngaylog= $("#ngaylog").val();	
    var url = atob(script_url)+"?callback=ctrlq&ngaylog="+ngaylog +"&action=Thoatconfirm";	  
//alert(ngaylog);  
    var request = jQuery.ajax({
      crossDomain: true,
      url: url ,
      method: "GET",
      dataType: "jsonp"

	  });
   setTimeout(function() {
	//close();
	window.location.href = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '');
    Thoatme.style.display = "none";	
   }, 500); // Thay đổi giá trị 2000 nếu bạn cần độ trễ khác
}	
//Chạy hàm thoát khi bấm nút Back của sổ trình duyệt Browse
window.addEventListener("popstate", function (event) {
    //Thoatconfirm_value();
});
//Chạy hàm thoát khi Close Tab hoặc đóng của sổ trình duyệt Browse
window.addEventListener("beforeunload", function (event) {
	Thoatconfirm_value();
    //event.preventDefault(); // Bắt buộc trên Chrome, Edge, Firefox
});
window.addEventListener("pagehide", function() {
    Thoatconfirm_value();
});
document.addEventListener("visibilitychange", function () {
    var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (document.visibilityState === "hidden" && isSafari) {
        Thoatme.style.display = "block";
    }
});

 
document.getElementById("cancel").onclick = function(){cancel()};
function cancel() {

    Thoatme.style.display = "none";
}

function close_window() {
	close();	
}

// ---------------------------


//OK--------
 
document.addEventListener('contextmenu', event => event.preventDefault());
history.pushState(null, null, document.URL);
window.addEventListener('popstate', function () {
    history.pushState(null, null, document.URL);
});




$(document).ready(function() {

Readtime_value();

 var url = location.protocol;

 if (url == "file:KHANH") {
	close();

	} else {
			//==== Lịch ====


		//====End Lịch ====
	}

});



// ----------------------

  function ctrlq(e) {

			document.getElementById("ngay").value = e.result;
			//alert(document.getElementById("ngay").value);
			//alert(document.getElementById("combine").value);
			let text = document.getElementById("ngay").value;
				// Lấy 12 chử cuối để kiểm tra
				let word = text.split(/\s+/); 	// Sử dụng biểu thức chính quy để tách chuỗi theo khoảng trắng	
				// Lấy 9 chử tính từ cuối cùng
				let String = word.slice(-15); 		
				// Kết hợp lại thành một chuỗi
				let StringLast = String.join(" ");


			if (text == "Quathoigian") {

					document.getElementById("id-container").style.display = "block";
					document.getElementById("id_alert").innerHTML = "Vui lòng thực hiện lại đăng nhập !";
					
					document.getElementById("confirm_id").onclick = function(){confirm_id()};
					function confirm_id() {
						Thoatconfirm_value();
					}
			}

			if (StringLast.indexOf("Cập")> 0) {

					let words = StringLast.split(/\s+/); 	// Sử dụng biểu thức chính quy để tách chuỗi theo khoảng trắng	
					let lastTenWords = words.slice(-6); 		
					let resultString = lastTenWords.join(" ");

					dialog_result.style.display = "block";
					document.getElementById("id_result").innerHTML = resultString;
					document.getElementById("id_result1").style.display = "block"; //id_result1 chạy Cập nhật
					document.getElementById("id_result2").style.display = "none"; //id_result2 chạy Thêm
					document.getElementById("id_result3").style.display = "none"; //id_result3 chạy Xóa
					document.getElementById("id_result4").style.display = "none"; //id_result4 Thông báo trùng
					
					} else if (StringLast.indexOf("Nhập")> 0) {

					let words = StringLast.split(/\s+/); 	// Sử dụng biểu thức chính quy để tách chuỗi theo khoảng trắng	
					let lastTenWords = words.slice(-11); 		
					let resultString = lastTenWords.join(" ");

					dialog_result.style.display = "block";
					document.getElementById("id_result").innerHTML = resultString;
					document.getElementById("id_result1").style.display = "none";
					document.getElementById("id_result2").style.display = "block";					
					document.getElementById("id_result3").style.display = "none";					
					document.getElementById("id_result4").style.display = "none";	
					
					} else if (StringLast.indexOf("Xóa")> 0) {

					let words = StringLast.split(/\s+/); 	// Sử dụng biểu thức chính quy để tách chuỗi theo khoảng trắng	
					let lastTenWords = words.slice(-5); 		
					let resultString = lastTenWords.join(" ");

					dialog_result.style.display = "block";
					document.getElementById("id_result").innerHTML = resultString + ". STT đã được đánh lại mới.";
					document.getElementById("id_result1").style.display = "none";
					document.getElementById("id_result2").style.display = "none";
					document.getElementById("id_result3").style.display = "block";
					document.getElementById("id_result4").style.display = "none";
					
					} else if (StringLast.indexOf("trùng")> 0 || StringLast.indexOf("tồn")> 0) {

					let words = StringLast.split(/\s+/); 	// Sử dụng biểu thức chính quy để tách chuỗi theo khoảng trắng	
					// Lấy 9 chử tính từ cuối cùng
					let lastTenWords = words.slice(-11); 		
					// Kết hợp lại thành một chuỗi
					let resultString = lastTenWords.join(" ");

					dialog_result.style.display = "block";
					document.getElementById("id_result").innerHTML = resultString;
					document.getElementById("id_result1").style.display = "none";
					document.getElementById("id_result2").style.display = "none";
					document.getElementById("id_result3").style.display = "none";
					document.getElementById("id_result4").style.display = "block";	

			} else if (text.indexOf("quyền") > 0 ) {
				dialog_result.style.display = "block";
				document.getElementById("id_result").innerHTML = text;
				document.getElementById("id_result1").style.display = "block";
				document.getElementById("id_result2").style.display = "none";
				document.getElementById("id_result3").style.display = "none";
				document.getElementById("id_result4").style.display = "none";
				//alert("quyền");			
			} else if (text.indexOf("lòng") > 0 ) {
					dialog_result.style.display = "block";
					document.getElementById("id_result").innerHTML = text;
					document.getElementById("id_result1").style.display = "none";
					document.getElementById("id_result2").style.display = "block";
					document.getElementById("id_result3").style.display = "none";
					document.getElementById("id_result4").style.display = "none";

					document.getElementById("id_result2").onclick = function(){confirm_id2()};
					function confirm_id2() {
						document.getElementById("dialog_result").style.display = "none";
						Thoatconfirm_value();
					}					
//				alert("lòng");	
					
				} else {
	  
		}


	var Thoat_confirm_result4 = document.getElementById("confirm_result4"); //id_result4 Thông báo trùng khi thêm dữ liệu
	document.getElementById("confirm_result4").onclick = function(){confirm_result4()};
	function confirm_result4() {		
		dialog_result.style.display = "none";
	}
	
		
	if (document.getElementById("ngay").value == "") {
	 } else {
		 ChangeID();
	}
		
		$("#re").html(e.result);
		$("#re").css("visibility","visible");

	 }
	var Thoat_resultme1 = document.getElementById("dialog_result");
	document.getElementById("confirm_result1").onclick = function(){confirm_result1()};
	function confirm_result1() {		
		Thoat_resultme1.style.display = "none";		
	}

	var Thoat_resultme2 = document.getElementById("dialog_result"); 
	document.getElementById("confirm_result2").onclick = function(){confirm_result2()};
	function confirm_result2() {		
		Thoat_resultme2.style.display = "none";
			//close(); //Không bật clóe
	}
 
 
function Readtime_value() {
				// Lấy giá trị từ localStorage
	//var idngaylog = localStorage.getItem('part2');
	var idngaylog = "56565655202743475031212121290634348042";	
	//alert(savedPart2); // Hiển thị giá trị đã lưu trữ trong localStorage
 
	var ngay= $("#ngay").val();	
    var url = atob(script_url)+"?callback=ctrlq&ngay="+ngay+ "&idngaylog=" + idngaylog +"&action=Readtime";	  
    var request = jQuery.ajax({
      crossDomain: true,
      url: url ,
      method: "GET",
      dataType: "jsonp"

	  });	
	localStorage.removeItem('part2');
	//alert(savedPart2); // Hiển thị giá trị đã lưu trữ trong localStorage
		
}	


	
	
function getPart1(str) {        // Lấy chuổi trái của "ngay"
    return str.split(' ')[0];
}
		
function getPart2(str) {        // Lấy chuổi phải của "ngay"
    return str.split(' ')[1];
}

function ChangeID() {
	document.getElementById("capnhatgiaphachi").value = getPart2(document.getElementById("ngay").value);   // Lấy chuổi phải của "ngay"
	// Đổi Value ngày: gán giá trị 'ngay' cho 'ngay2' sau dó đổi ngay2 thành 'ngaylog'
	if (document.getElementById('ngay2')) {
	document.getElementById("ngay2").value = getPart1(document.getElementById("ngay").value); // Lấy chuổi trái của "ngay"
	document.getElementById('ngay2').id = 'ngaylog';
	document.getElementById('capnhatgiaphachi').id = 'combine';

	//CheckNgaylog_value();
//==== CHÚ Ý: CHUỔI combine LÀ CHỬ THƯỜNG KHÔNG VIÊT HOA giaphachi Thêm Ẩn/Hiện=====
	if (document.getElementById("combine").value == "giaphachi" && document.getElementById("combine").value !== "" ) {
		document.getElementById('legend').innerHTML = "CẬP NHẬT GIA PHẢ";
		readDatagiaphachi_value();
	
		const updateDiv = document.getElementById("update");	
		updateDiv.style.display = "none";			 
	
	}
			

  }
}

document.getElementById("btn-show-updateOn").onclick = function(){show_updateOn()};
function show_updateOn() {
    const updateDiv = document.getElementById("update");
    updateDiv.style.display = (updateDiv.style.display === "block") ? "none" : "block";
}

//-----------------------UPDATE--------------------

document.getElementById("btn-show-update").onclick = function(){show_update()}; // Không sử dụng nữa
var Thoat_updateme = document.getElementById("update-container");

function show_update() {

    // Thực hiện các thao tác sau một khoảng thời gian (ví dụ: 2 giây)
    setTimeout(function() {
	document.getElementById("id_Up").innerHTML = "Bạn muốn Cập nhật dòng thứ: " + document.getElementById("id").value + " không ? " ;
	// Kiểm tra điều kiện và thực hiện các thao tác liên quan
        if (document.getElementById('id').value === "" || document.getElementById('id').value < 0) {
            // Ẩn container cập nhật và hiển thị cảnh báo ID
            Thoat_updateme.style.display = "none";
            document.getElementById("id-container").style.display = "block";
			
            document.getElementById("id_alert").innerHTML = "Hãy chọn một dòng để cập nhật !";

            // Xử lý khi xác nhận ID
            document.getElementById("confirm_id").onclick = function() {
                document.getElementById("id-container").style.display = "none";
            };

            return false;
        }

        // Hiển thị container cập nhật
        Thoat_updateme.style.display = "block";
    }, 1000); // Thay đổi giá trị 2000 nếu bạn cần độ trễ khác
}



document.getElementById("confirm_update").onclick = function(){confirm_update()};
function confirm_update() {
  cancel_update();
  var combineValue = document.getElementById("combine").value;
  if (combineValue === "") {
    return false; // Thoát ngay nếu giá trị combine trống
  } else {
   setTimeout(function() {
//  alert("Chạy hàm updategiaphachi_value");
    updategiaphachi_value(); 
   }, 500); // Thay đổi giá trị 2000 nếu bạn cần độ trễ khác
  }
}

document.getElementById("cancel_update").onclick = function(){cancel_update()};
function cancel_update() { 
    Thoat_updateme.style.display = "none";
}

//------------------INSERT-------------------
document.getElementById("btn-show-insert").onclick = function() {
    show_insert();
};

var Thoat_insertme = document.getElementById("insert-container");

function show_insert () {

  /*  Đặt delay nếu thật sự cần đợi người dùng gõ xong  */
  setTimeout(() => {

    /* ----- 1. Khai báo thứ tự kiểm tra & tên nhãn ----- */
    const checks = [
      { id: 'Colum2', label: 'Họ tên' },
      { id: 'Colum3', label: 'Gán Id' },
      { id: 'Colum4', label: 'Kết nối đến Id' },
      { id: 'Colum5', label: 'Mối quan hệ' },
      { id: 'Colum6', label: 'Lớp thứ' }
    ];

    /* ----- 2. Tìm ô đầu tiên còn trống ----- */
    let missing = null;                  // sẽ chứa nhãn của ô trống đầu tiên
    for (const f of checks) {
      const val = (document.getElementById(f.id)?.value || '').trim();
      if (!val) {                        // rỗng ⇒ stop & báo lỗi
        missing = f.label;
        break;
      }
    }

    /* ----- 3. Nếu thiếu -> hiện cảnh báo; ngược lại -> mở hộp thoại nhập mới ----- */
    if (missing) {
      // Ẩn dialog “insert” nếu đang mở
      if (typeof Thoat_insertme !== 'undefined')
        Thoat_insertme.style.display = "none";

      // Hiện popup cảnh báo
      const dlg = document.getElementById("id-container");
      dlg.style.display = "block";
      document.getElementById("id_alert").innerText = "Chưa nhập ô " + missing;

      // Nút OK đóng popup
      document.getElementById("confirm_id").onclick = () => {
        dlg.style.display = "none";
      };

      return false;                      // chặn các thao tác tiếp
    }

    /* ----- 4. Đã đủ dữ liệu: hỏi thêm mới dòng ----- */
    document.getElementById("id_Ins").innerText =
      "Bạn muốn nhập thêm mới dòng dữ liệu này không ?";
    if (typeof Thoat_insertme !== 'undefined')
      Thoat_insertme.style.display = "block";

  }, 100);   // 100 ms là đủ, hoặc bỏ setTimeout nếu không cần trễ
}





document.getElementById("confirm_insert").onclick = function(){confirm_insert()};
function confirm_insert() {
Thoat_insertme.style.display = "none";
		if (document.getElementById("combine").value == "giaphachi" && document.getElementById("combine").value !== "" ) {
			insertgiaphachi_value();			
		} else {
				Thoat_insertme.style.display = "none";
				document.getElementById("id-container").style.display = "block";

				document.getElementById("id_alert").innerHTML = "Chọn Trạm đang đăng nhập để thêm số liệu !";	

				document.getElementById("confirm_id").onclick = function(){confirm_id()};
				function confirm_id() {
					document.getElementById("id-container").style.display = "none";	
				}
				return false;
		}	
		Thoat_insertme.style.display = "none";    	
}

document.getElementById("cancel_insert").onclick = function(){cancel_insert()};
function cancel_insert() { 
    Thoat_insertme.style.display = "none";
}

//---DELETE---

document.getElementById("btn-show-delete").onclick = function(){show_delete()};
var Thoat_deleteme = document.getElementById("delete-container");

function show_delete() {
    setTimeout(function() {
	document.getElementById("id_Del").innerHTML = "Bạn muốn Xóa dòng thứ " + document.getElementById("id").value + " không ? " ;
		if (document.getElementById('id').value === "" || document.getElementById('id').value < 0 ) {
		// alert("OK");
			Thoat_deleteme.style.display = "none";	
			document.getElementById("id-container").style.display = "block";
			document.getElementById("id_alert").innerHTML = "Hãy chọn một dòng muốn xóa !";	

			document.getElementById("confirm_id").onclick = function(){confirm_id()};
			function confirm_id() {
				document.getElementById("id-container").style.display = "none";	
			}

				return false;
		}
			Thoat_deleteme.style.display = "block";
    }, 500); // Thay đổi giá trị 2000 nếu bạn cần độ trễ khác
}


document.getElementById("confirm_delete").onclick = function(){confirm_delete()};

function confirm_delete() {

  cancel_delete();
  var combineValue = document.getElementById("combine").value;
  if (combineValue === "") {
    return false; // Thoát ngay nếu giá trị combine trống

  } else {
  //alert("Xóa");
    deletegiaphachi_value();
  }
	
}

document.getElementById("cancel_delete").onclick = function(){cancel_delete()};
function cancel_delete() { 
    Thoat_deleteme.style.display = "none";
}

// THAY


function updategiaphachi_value() {
    $("#re").css("visibility", "hidden");
    document.getElementById("loader").style.visibility = "visible";

    var ngaylog = $("#ngaylog").val();
    var combine = $("#combine").val();
    var id = $("#id").val();

    // Tạo chuỗi URL động với các cột Colum2 đến Colum67
    var url = atob(script_url) + "?callback=ctrlq&id=" + id;

    for (let i = 2; i <= 24; i++) {
        let value = $('#Colum' + i).val();
        url += "&Colum" + i + "=" + encodeURIComponent(value);
    }
    url += "&ngaylog=" + encodeURIComponent(ngaylog) + "&combine=" + encodeURIComponent(combine) + "&action=updategiaphachi";

    // Gửi request
    var request = $.ajax({
        crossDomain: true,
        url: url,
        method: "GET",
        dataType: "jsonp"
    });

    // Xóa dữ liệu sau khi gửi
    document.getElementById("id").value = "";
    for (let i = 2; i <= 24; i++) {
        document.getElementById("Colum" + i).value = "";
    }
}


function deletegiaphachi_value() {
    $("#re").css("visibility", "hidden");
    document.getElementById("loader").style.visibility = "visible";

    var ngaylog = $("#ngaylog").val();
    var combine = $("#combine").val();
    var id = $("#id").val();

    // Tạo chuỗi URL động với các cột Colum2 đến Colum67
    var url = atob(script_url) + "?callback=ctrlq&id=" + id;

    for (let i = 2; i <= 24; i++) {
        let value = $('#Colum' + i).val();
        url += "&Colum" + i + "=" + encodeURIComponent(value);
    }
    url += "&ngaylog=" + encodeURIComponent(ngaylog) + "&combine=" + encodeURIComponent(combine) + "&action=deletegiaphachi";

    // Gửi request
    var request = $.ajax({
        crossDomain: true,
        url: url,
        method: "GET",
        dataType: "jsonp"
    });

    // Xóa dữ liệu sau khi gửi
    document.getElementById("id").value = "";
    for (let i = 2; i <= 24; i++) {
        document.getElementById("Colum" + i).value = "";
    }
}

  
function insertgiaphachi_value() {
    $("#re").css("visibility", "hidden");
    document.getElementById("loader").style.visibility = "visible";

    var ngaylog = $("#ngaylog").val();
    var combine = $("#combine").val();
    var id = $("#id").val();

    // Tạo chuỗi URL động với các cột Colum2 đến Colum67
    var url = atob(script_url) + "?callback=ctrlq&id=" + id;

    for (let i = 2; i <= 24; i++) {
        let value = $('#Colum' + i).val();
        url += "&Colum" + i + "=" + encodeURIComponent(value);
    }
    url += "&ngaylog=" + encodeURIComponent(ngaylog) + "&combine=" + encodeURIComponent(combine) + "&action=insertgiaphachi";

    // Gửi request
    var request = $.ajax({
        crossDomain: true,
        url: url,
        method: "GET",
        dataType: "jsonp"
    });

    // Xóa dữ liệu sau khi gửi
    document.getElementById("id").value = "";
    for (let i = 2; i <= 24; i++) {
        document.getElementById("Colum" + i).value = "";
    }
}
 

//------------------------Upload File-----------------------------


document.getElementById("fileUpload").addEventListener("change", function () {
    const label = document.querySelector(".custom-file-upload");
    label.textContent = this.files.length > 0 ? this.files[0].name : "Browse";
});

async function insertgiaphachiExcel_value() {
    const fileUpload = document.getElementById("fileUpload").files[0];

    if (!fileUpload) {
        alert("Hãy chọn File Excel để Upload!");
        return false;
    }

    const Thoat_Upload = document.getElementById("updateExcel-container");
    Thoat_Upload.style.display = "block";
    //sendBegin();
    document.getElementById("id_UpExcel").innerHTML = "Bạn muốn Upload dữ liệu từ file Excel không?";

    document.getElementById("cancel_updateExcel").onclick = () => {
        Thoat_Upload.style.display = "none";
    };

    document.getElementById("confirm_updateExcel").onclick = async () => {
        Thoat_Upload.style.display = "none";
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

            const nonEmptyRows = excelData.filter(row => row.some(cell => cell !== undefined && cell !== null && cell !== ''));
            const totalRows = nonEmptyRows.length;

            if (totalRows <= 1) {
                alert("File Excel không có dữ liệu!");
                return false;
            }

            const dataRows = nonEmptyRows.slice(1);
            document.getElementById("output").value = JSON.stringify(dataRows);
            
            await sendData(); // Gửi dữ liệu sau khi có dataExcel
        };

        reader.readAsBinaryString(fileUpload); // Đọc file Excel
    };
}


async function sendData() {
    const ngaylog = document.getElementById("ngaylog").value;
    const combine = document.getElementById("combine").value;
    const dataExcel = document.getElementById("output").value; // Lấy dữ liệu Excel

    // Tạo đối tượng dữ liệu để gửi
    const postData = {
        ngaylog: ngaylog,
        combine: combine,
        dataExcel: dataExcel,
        action: "insertgiaphachiExcel"
    };

    try {
        // Gửi yêu cầu AJAX với phương thức POST
        const response = await jQuery.ajax({
            url: atob(script_url), // Chuyển URL từ base64
            method: "POST",
            data: postData,
            dataType: "text" // Chờ đợi phản hồi dưới dạng văn bản
        });

	// Phân tích cú pháp phản hồi từ server
	const result = JSON.parse(response); // Phân tích cú pháp phản hồi JSON

	// Hiển thị thông báo kết quả từ server
	document.getElementById("output").value = result.result;

	let textExcel = result.result; // Gán giá trị từ server vào biến textExcel
	// Kiểm tra xem thông báo có chứa từ "Upload" không
	if (textExcel.indexOf("Upload") > 0) {

		// Tách chuỗi thành mảng các từ bằng cách sử dụng biểu thức chính quy
		let words = textExcel.split(/\s+/); 		
		// Lấy 10 từ cuối cùng
		let lastTenWords = words.slice(-18); 		
		// Kết hợp lại thành một chuỗi
		let resultString = lastTenWords.join(" "); 
		
		// Hiển thị hộp thoại và chuỗi kết quả
		document.getElementById("dialog_resultExcel").style.display = "block"; // Hiển thị hộp thoại
		document.getElementById("id_resultExcel_1").innerHTML = resultString; // Hiển thị chuỗi đã xử lý
	}
       
    } catch (error) {
        alert("Có lỗi xảy ra khi gửi dữ liệu: " + error.message); // Hiển thị lỗi nếu có
    }
}

//======HÀM OK=======

//---Xuất Cây ra ảnh SVG---
function exportToSVG() {
  const svg = document.querySelector("#familyTree");

  // Bước 1: Chuyển tất cả <image> trong SVG thành base64
  const images = svg.querySelectorAll("image");
  const promises = Array.from(images).map(img => {
    const href = img.getAttribute("href");
    return fetch(href)
      .then(res => res.blob())
      .then(blob => new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => {
          img.setAttribute("href", reader.result); // Gán base64 vào href
          resolve();
        };
        reader.readAsDataURL(blob);
      }))
      .catch(err => {
        console.warn("Không thể chuyển ảnh:", href, err);
      });
  });

  Promise.all(promises).then(() => {
    // Bước 2: Serialize SVG thành PNG như cũ
    const svgData = new XMLSerializer().serializeToString(svg);
    const svgBlob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    img.onload = function () {
      const canvas = document.createElement("canvas");
      const scale = 3;
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.scale(scale, scale);
      ctx.drawImage(img, 0, 0);
      URL.revokeObjectURL(url);

      const pngUrl = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      link.href = pngUrl;
      link.download = "cay_gia_pha.png";
      link.click();
    };
    img.src = url;
  });
}

document.getElementById("btnPNG").onclick = () => {
    exportToSVG();
};

async function exportToPDF() {
  const svgElement = document.getElementById("familyTree");

  // Lấy vùng bao thật của sơ đồ
  const bbox = svgElement.getBBox();
  const margin = 50; // 👈 thêm lề để không bị cắt mất node
  const width = bbox.width + margin * 2;
  const height = bbox.height + margin * 2;

  const clonedSvg = svgElement.cloneNode(true);
  clonedSvg.setAttribute("width", width);
  clonedSvg.setAttribute("height", height);
  clonedSvg.setAttribute("viewBox", `${bbox.x - margin} ${bbox.y - margin} ${bbox.width + margin * 2} ${bbox.height + margin * 2}`);

  const svgString = new XMLSerializer().serializeToString(clonedSvg);

  const canvas = document.createElement("canvas");
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext("2d");

  const v = await canvg.Canvg.from(ctx, svgString);
  await v.render();

  const imgData = canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: width > height ? "landscape" : "portrait",
    unit: "pt",
    format: [width, height]
  });

  pdf.addImage(imgData, 'PNG', 0, 0, width, height);
  pdf.save("family_tree.pdf");
}

document.getElementById("btnPDF").onclick = () => {
    exportToPDF();
};	


//---Menu Export----
const menuBtn = document.getElementById("menuIconBtn");
const menuContent = document.getElementById("menuContent");

menuBtn.addEventListener("click", () => {
  const isVisible = menuContent.style.display === "block";
  menuContent.style.display = isVisible ? "none" : "block";
});

// Ẩn menu nếu bấm ra ngoài
document.addEventListener("click", function (event) {
  if (!event.target.closest(".menu-container")) {
    menuContent.style.display = "none";
  }
});


 //---------------------------------------------------------------- 

//--- Cấu hình Lịch Ag-grid ngôn ngữ tiếng Việt cho jQuery UI Datepicker----
// Cấu hình Datepicker ngôn ngữ tiếng Việt
$.datepicker.regional['vi'] = {
    closeText: 'Đóng',
    prevText: '&#x3C;Trước',
    nextText: 'Tiếp&#x3E;',
    currentText: 'Hôm nay',
    monthNames: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5', 'Tháng 6',
        'Tháng 7', 'Tháng 8', 'Tháng 9', 'Tháng 10', 'Tháng 11', 'Tháng 12'],
    monthNamesShort: ['Th1', 'Th2', 'Th3', 'Th4', 'Th5', 'Th6', 'Th7', 'Th8', 'Th9', 'Th10', 'Th11', 'Th12'],
    dayNames: ['Chủ Nhật', 'Thứ Hai', 'Thứ Ba', 'Thứ Tư', 'Thứ Năm', 'Thứ Sáu', 'Thứ Bảy'],
    dayNamesShort: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
    dayNamesMin: ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'],
    weekHeader: 'Tuần',
    dateFormat: 'dd/mm/yy',
    firstDay: 0,
    isRTL: false,
    showMonthAfterYear: false,
    yearSuffix: ''
};
$.datepicker.setDefaults($.datepicker.regional['vi']);

// Định nghĩa DatepickerEditor cho ag-Grid
function DatepickerEditor() {}

DatepickerEditor.prototype.init = function(params) {
    this.params = params;
    this.oldValue = params.value; // Lưu giá trị cũ

    this.eInput = document.createElement('input');
    this.eInput.type = 'text';
    this.eInput.value = params.value || '';
    this.eInput.style.width = '100%';

    $(this.eInput).datepicker({
        dateFormat: 'dd/mm/yy',
        showButtonPanel: true,
        closeText: 'Đóng',
        currentText: 'Hôm nay',
        onSelect: () => params.stopEditing(),
        beforeShow: (input, inst) => {
            setTimeout(() => {
                var buttonPane = $(inst.dpDiv).find(".ui-datepicker-buttonpane");

                // Thêm nút "Hôm nay"
                if (buttonPane.find('.ui-datepicker-current').length === 0) {
                    var btnToday = $('<button>', {
                        text: 'Hôm nay',
                        click: () => {
                            var today = new Date();
                            var formattedDate = $.datepicker.formatDate('dd/mm/yy', today);
                            $(input).val(formattedDate).change();
                            params.stopEditing();
                            $(input).datepicker("hide");
                        }
                    }).addClass('ui-datepicker-current ui-state-default ui-priority-primary ui-corner-all');
                    buttonPane.append(btnToday);
                }

                // Thêm nút "Đóng"
                if (buttonPane.find('.ui-datepicker-close').length === 0) {
                    var btnClose = $('<button>', {
                        text: 'Đóng',
                        click: () => {
                            $(input).datepicker("hide");
                            params.stopEditing();
                        }
                    }).addClass('ui-datepicker-close ui-state-default ui-priority-secondary ui-corner-all');
                    buttonPane.append(btnClose);
                }
            }, 1);
        }
    });

    this.eInput.focus();
};

// Trả về giao diện của input
DatepickerEditor.prototype.getGui = function() {
    return this.eInput;
};

// Hiển thị Datepicker ngay khi input xuất hiện
DatepickerEditor.prototype.afterGuiAttached = function() {
    this.eInput.focus();
    $(this.eInput).datepicker("show");
};

// Lấy giá trị ngày đã chọn với kiểm tra định dạng
DatepickerEditor.prototype.getValue = function() {
    var value = this.eInput.value.trim();

    // Kiểm tra định dạng dd/mm/yyyy bằng regex
    var dateRegex = /^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[0-2])\/\d{4}$/;

    if (dateRegex.test(value)) {
        return value; // Hợp lệ, trả về giá trị mới
    } else {
        alert("⚠️ Ngày nhập không đúng định dạng dd/mm/yyyy!");
        return this.oldValue; // Không hợp lệ, giữ nguyên giá trị cũ
    }
};

// Hủy Datepicker khi không cần thiết nữa
DatepickerEditor.prototype.destroy = function() {
    $(this.eInput).datepicker("destroy");
};

// Xác định Datepicker là một popup
DatepickerEditor.prototype.isPopup = function() {
    return true;
};
//---End Cấu hình Lịch Ag-grid ngôn ngữ tiếng Việt cho jQuery UI Datepicker----
 
function readDatagiaphachi_value() {
    var ngaylog = $("#ngaylog").val();

    if (document.getElementById("combine").value == "") {
        document.getElementById("id-container").style.display = "block";
        document.getElementById("id_alert").innerHTML = "Hãy đăng nhập!";
        document.getElementById("confirm_id").onclick = function() {
            document.getElementById("id-container").style.display = "none";
        };
        return false;
    } else {
        $("#re").css("visibility", "hidden");

        var url = atob(script_url)+"?action=readgiaphachi&ngaylog=" + ngaylog;

        document.getElementById("spinner").style.display = "block"; // Hiển thị spinner

        $.getJSON(url, function(json) {
            var columnDefs = [

			    { headerName: "STT", field: "ID", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 90, pinned: 'left', checkboxSelection: true, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Lớp thứ", field: "Colum2", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum2"},
				
                { headerName: "Họ Tên", field: "Colum3", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 160, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum3" },
                { headerName: "Giới tính", field: "Colum4", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum4" },				
                { headerName: "Gán Id", field: "Colum5", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum5" },
                { headerName: "Kết nối đến Id", field: "Colum6", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 120, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum6" },
                { headerName: "Mối quan hệ", field: "Colum7", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 160, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum7"},

                { headerName: "Vị trí thứ", field: "Colum8", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum8" },
                { headerName: "Sinh ngày", field: "Colum9", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 120, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Quê quán", field: "Colum10", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 200, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Kết hôn", field: "Colum11", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 160, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Con", field: "Colum12", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 190, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}},
                { headerName: "Thông tin", field: "Colum13", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 500, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}},
                { headerName: "Link Avatar", field: "Colum14", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 400, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Edit", field: "Colum15", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 140, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },				
                { headerName: "Người cập nhật", field: "Colum16", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 140, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Ngày cập nhật", field: "Colum17", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 140, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },

                { headerName: "Header 1", field: "Colum18", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum7"},
                { headerName: "Header 2", field: "Colum19", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 100, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}, tooltipField: "GhichuColum8" },
                { headerName: "Header 3", field: "Colum20", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 120, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Header 4", field: "Colum21", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 200, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Header 5", field: "Colum22", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 160, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} },
                { headerName: "Header 6", field: "Colum23", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 190, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}},
                { headerName: "Header 7", field: "Colum24", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 500, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned}},
                { headerName: "Header 8", field: "Colum25", cellRenderer: highlightSearchText, filter: 'agTextColumnFilter', width: 400, valueGetter: getValue, valueSetter: setValue, cellEditor: 'agLargeTextCellEditor', cellClass: params => {return params.node.rowPinned ? 'wrap-text-cell' : '';}, editable: params => params.node.rowPinned, cellClassRules: {'red-border-cell': params => params.node.rowPinned} }				

				];
			var pinnedRowData = [{
				//ID: '',
				Colum2: '', Colum3: '', Colum4: '', Colum5: '', Colum6: '', Colum7: '', Colum8: '', Colum9: '', Colum10: '', Colum11: '', Colum12: '', Colum13: '', Colum14: '', Colum15: '',
				GhichuColum2: "Nhập lớp thứ, trong cây gia phả tính từ trên xuống là 1 ..",GhichuColum3: "Nhập họ và tên",GhichuColum4: "Nhập Nam hoặc Nữ",GhichuColum5: "Id nguồn",GhichuColum6: "Id kết nối đích đến.",GhichuColum7: "Có các kiểu kết nối Vợ, Chồng hoặc Con giữa Id nguồn với Id đích tương ứng.",GhichuColum8: "Ta có thể vẽ thành viên ở vị trí thứ mấy trong lớp, vị trí 1,2.. thích hợp tương ứng cho thành viên."
			}];


            var gridOptions = {
                columnDefs: columnDefs,
                rowData: json.records,
				
				getRowHeight: params => {
				if (params.node.rowPinned) {
					return 60; // Đặt chiều cao cho pinned row
				}
					//return 30; // Chiều cao mặc định cho các row khác
				},
				//rowSelection: 'multiple', //Chọn nhiều Check Box
				pinnedTopRowData: pinnedRowData,
				singleClickEdit: true,    // Cho phép chỉnh sửa bằng một lần nhấp
                pagination: true,
                paginationPageSize: 50,
                paginationPageSizeSelector: [50, 100, 200, 300, 400, 500, 600, 10000],

                defaultColDef: {
                    floatingFilter: true,
					wrapHeaderText: true,					
					resizable: true,
					wrapText: false, // Không wrap text cho dữ liệu thường
					autoHeight: true, // Cho phép tự điều chỉnh chiều cao khi có wrap text
					suppressMenuHide: false
					//suppressMenuHide: false // Hiển thị menu cột khi nhấn vào icon menu
                },
				
                onGridReady: function() {  // Sự kiện nút "Reset"
				DanhSoThuTuColum8();
				drawChart();				// Gọi hàm vẽ Chart
				document.getElementById('resetFilterButton').addEventListener('click', function () {
				gridOptions.api.setFilterModel(null); // Xóa tất cả các bộ lọc hiện tại
					gridOptions.api.onFilterChanged(); // Kích hoạt cập nhật bộ lọc
					
					// Xóa bộ đếm kết quả tìm kiếm
					document.getElementById('filterText').value = '';
					filterText = '';
					document.getElementById('count').innerText = '';
					var searchText = this.value.toUpperCase();
					gridOptions.api.setQuickFilter(searchText);

					// Bỏ chọn checkbox
                    gridOptions.api.forEachNode(function(node) {
                        node.setSelected(false);
                    });				
					unhideAllColumns();

					// Cập nhật lại giao diện lưới
					gridOptions.api.closeToolPanel(); // Ẩn ToolPanel Chọn cột
					setTimeout(function() {
						gridOptions.api.refreshCells({ force: true });
					}, 0);	

				});

                addResizeHandles();

//-----FORM NHẬP LIỆU Get dữ liệu dòng Ag vào các Input------
document.querySelector("form").addEventListener("submit", function(e) {
  e.preventDefault(); // 🚫 Ngăn reload trang khi ấn Enter
});


  document.getElementById("closeForm").onclick = function () {
    document.getElementById("nhaplieu").style.display = "none";
	  form.style.display = 'none';
	  showBtn.value = 'Hiện Form';
  };
  document.getElementById("cancelBtn").onclick = function () {
    document.getElementById("nhaplieu").style.display = "none";
  };
  
const showBtn = document.getElementById('showFormBtn');
const form = document.getElementById('nhaplieu');

showBtn.onclick = () => {
    if (form.style.display === 'flex') {
      form.style.display = 'none';
	  showBtn.value = 'Hiện Form';
    } else {
      form.style.display = 'flex';
	  showBtn.value = 'Ẩn Form';
	  DanhSoThuTuColum8();
    }
};  
//==========================

//====CÁC HÀM CANH CHỈNH CÂY GIA PHẢ========
function DanhSoThuTuColum8() {
    const allData = [];
    gridOptions.api.forEachNode(node => allData.push(node.data));

    // Nhóm theo đời
    const groups = {};
    allData.forEach(row => {
        const doi = row.Colum2;
        if (!groups[doi]) groups[doi] = [];
        groups[doi].push(row);
    });

    Object.keys(groups).forEach(doi => {
        const group = groups[doi];
        const ordered = group.slice();

        // Đánh số tạm ban đầu
        ordered.forEach((r, idx) => r.Colum8 = idx + 1);

        // --- Bước 1: Xử lý vợ/chồng ---
        for (let i = 0; i < group.length; i++) {
            const row = group[i];
            if (!row || !row.Colum7) continue;
            const rel = String(row.Colum7).trim().toLowerCase();
            if (rel === 'vợ' || rel === 'chồng' || rel === 'chong') {
                const spIdx = ordered.findIndex(r => r.Colum5 === row.Colum5);
                if (spIdx !== -1) ordered.splice(spIdx, 1);

                const partnerIdx = ordered.findIndex(r => r.Colum5 === row.Colum6);
                if (partnerIdx === -1) {
                    ordered.push(row);
                    continue;
                }

                let insertIdx = partnerIdx + 1;
                const partnerId = ordered[partnerIdx].Colum5;
                while (insertIdx < ordered.length && String(ordered[insertIdx].Colum6) === String(partnerId)) {
                    insertIdx++;
                }
                ordered.splice(insertIdx, 0, row);
            }
        }

        // --- Bước 2: Gom nhóm con cùng Colum6 ---
        const conGroups = {};
        ordered.forEach(r => {
            if (String(r.Colum7).trim().toLowerCase() === 'con') {
                if (!conGroups[r.Colum6]) conGroups[r.Colum6] = [];
                conGroups[r.Colum6].push(r);
            }
        });

        Object.keys(conGroups).forEach(parentId => {
            if (conGroups[parentId].length > 1) {
                // Sắp xếp theo Colum8 hiện tại
                conGroups[parentId].sort((a, b) => a.Colum8 - b.Colum8);

                // Tìm vị trí đầu tiên của nhóm này
                const firstIdx = ordered.findIndex(r => r.Colum5 === conGroups[parentId][0].Colum5);
                // Xóa nhóm ra khỏi ordered
                conGroups[parentId].forEach(r => {
                    const idx = ordered.findIndex(o => o.Colum5 === r.Colum5);
                    if (idx !== -1) ordered.splice(idx, 1);
                });
                // Chèn lại liên tiếp
                ordered.splice(firstIdx, 0, ...conGroups[parentId]);
            }
        });

        // --- Bước 3: Đánh lại số Colum8 ---
        ordered.forEach((r, idx) => {
            r.Colum8 = idx + 1;
        });
    });

    gridOptions.api.setRowData(allData);
	ChinhNamGiuaMeCon();
}


function ChinhNamGiuaMeCon() {
//-- Dịch và Canh chỉnh node Mẹ-Con---
    const allData = [];
    gridOptions.api.forEachNode(node => allData.push(node.data));

    // Lấy danh sách đời (Colum2) đã sắp xếp
    const doiList = [...new Set(allData.map(r => r.Colum2))].sort((a, b) => a - b);

    for (let i = 0; i < doiList.length - 1; i++) {
        const doiTren = doiList[i];
        const doiDuoi = doiList[i + 1];

        const groupTren = allData.filter(r => r.Colum2 === doiTren);
        const groupDuoi = allData.filter(r => r.Colum2 === doiDuoi);

        if (groupTren.length >= groupDuoi.length) continue;

        const conDuoi = groupDuoi.filter(r => String(r.Colum7).trim().toLowerCase() === 'con');

        const nhomCon = {};
        conDuoi.forEach(child => {
            if (!nhomCon[child.Colum6]) nhomCon[child.Colum6] = [];
            nhomCon[child.Colum6].push(child);
        });

        const idChaMeTren = groupTren.map(r => r.Colum5);

        let laNhomDau = true;

        idChaMeTren.forEach(parentId => {
            const parentRow = groupTren.find(r => r.Colum5 === parentId);
            if (!parentRow) return;

            if (nhomCon[parentId]) {
                if (laNhomDau) {
                    laNhomDau = false;
                } else {
                    // Sắp xếp con theo Colum8
                    const sortedKids = nhomCon[parentId].sort((a, b) => a.Colum8 - b.Colum8);
                    const firstX = sortedKids[0].Colum8;
                    const lastX = sortedKids[sortedKids.length - 1].Colum8;

                    // Trung điểm (có thể là .5)
                    const newX = (firstX + lastX) / 2;

                    const shift = newX - parentRow.Colum8;

                    if (shift !== 0) {
                        groupTren
                            .filter(r => r.Colum8 >= parentRow.Colum8)
                            .forEach(r => r.Colum8 += shift);
                    }
                }
            }
        });
    }

    gridOptions.api.setRowData(allData);
	HoanDoiNhomConLopDuoiTheoMe();
	
}

// Tiện ích bỏ dấu để so khớp "con" an toàn
function _deAcc(s) {
  return String(s || '')
    .trim()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '');
}

function HoanDoiNhomConLopDuoiTheoMe() {
  const allData = [];
  gridOptions.api.forEachNode((n) => allData.push(n.data));

  // Danh sách đời tăng dần
  const doiList = [...new Set(allData.map(r => Number(r.Colum2)))].sort((a, b) => a - b);

  for (let idx = 1; idx < doiList.length; idx++) {
    const doiDuoi = doiList[idx];
    const doiTren = doiList[idx - 1];

    const rowsDuoi = allData.filter(r => Number(r.Colum2) === doiDuoi);
    const rowsTren = allData.filter(r => Number(r.Colum2) === doiTren);

    // Chỉ lấy các hàng "Con" ở đời dưới
    const children = rowsDuoi.filter(r => _deAcc(r.Colum7) === 'con');
    if (children.length === 0) continue;

    // Gom nhóm con theo parentId (Colum6)
    const mapGroups = new Map();
    for (const kid of children) {
      const pid = kid.Colum6;
      if (!mapGroups.has(pid)) mapGroups.set(pid, []);
      mapGroups.get(pid).push(kid);
    }

    // Tạo danh sách nhóm
    const groups = [];
    for (const [parentId, kids] of mapGroups.entries()) {
      kids.sort((a, b) => Number(a.Colum8 ?? 0) - Number(b.Colum8 ?? 0));
      const oldBase = Number(kids[0]?.Colum8 ?? 0);
      const parentRow = rowsTren.find(r => String(r.Colum5) === String(parentId));
      const parentOrder = Number(parentRow?.Colum8 ?? Number.POSITIVE_INFINITY);
      groups.push({ parentId, kids, oldBase, parentOrder });
    }

    if (groups.length <= 1) continue;

    // Các vị trí base cũ
    const availableBases = groups.map(g => g.oldBase).sort((a, b) => a - b);

    // Sắp xếp nhóm theo vị trí cha/mẹ
    const desiredOrder = groups.slice().sort((a, b) => 
      (a.parentOrder === b.parentOrder)
        ? (a.oldBase - b.oldBase)
        : (a.parentOrder - b.parentOrder)
    );

    // Xử lý hoán đổi
    desiredOrder.forEach((g, i) => {
      const newBase = availableBases[i];
      const shift = (newBase ?? 0) - (g.oldBase ?? 0);
      if (shift !== 0) {
        g.kids.forEach(k => { k.Colum8 = Number(k.Colum8 ?? 0) + shift; });
      }

      const mother = rowsTren.find(r => String(r.Colum5) === String(g.parentId));
      let motherPos = Number(mother?.Colum8 ?? 0);

      if (i > 0) {
        const prevGroup = desiredOrder[i - 1];
        const prevLastChildPos = Number(prevGroup.kids[prevGroup.kids.length - 1]?.Colum8 ?? 0);

        if (prevLastChildPos >= motherPos) {
          const diff = prevLastChildPos - motherPos + 1;

          // Dịch mẹ
          if (mother) mother.Colum8 = motherPos + diff;

          // Dịch toàn bộ con của nhóm hiện tại
          g.kids.forEach(k => { k.Colum8 = Number(k.Colum8 ?? 0) + diff; });

          // Dịch tất cả các node lớp mẹ có vị trí >= mẹ mới
          const motherPosNew = Number(mother?.Colum8 ?? 0);
          const trenConflict = rowsTren.filter(r => Number(r.Colum8) >= motherPosNew && r !== mother);
          trenConflict.forEach(r => { r.Colum8 = Number(r.Colum8 ?? 0) + diff; });

          // Dịch tất cả các node lớp con có vị trí >= con cuối mới
          const lastChildPos = Number(g.kids[g.kids.length - 1]?.Colum8 ?? 0);
          const duoiConflict = rowsDuoi.filter(r => Number(r.Colum8) >= lastChildPos && !g.kids.includes(r));
          duoiConflict.forEach(r => { r.Colum8 = Number(r.Colum8 ?? 0) + diff; });
        }
      }
    });
  }

  gridOptions.api.setRowData(allData);
  VoChongKhongConVeSatNhau();
}

function VoChongKhongConVeSatNhau() {
  const allData = [];
  gridOptions.api.forEachNode(n => allData.push(n.data));

  const doiList = [...new Set(allData.map(r => Number(r.Colum2)))].sort((a, b) => a - b);

  doiList.forEach(doi => {
    const rows = allData.filter(r => Number(r.Colum2) === doi);

    rows.forEach(person => {
      const type = _deAcc(person.Colum7 || '');
      if (type !== 'vo' && type !== 'chong') return;

      // Kiểm tra có con không
      const hasChild = allData.some(r => 
        Number(r.Colum2) === doi + 1 && String(r.Colum6) === String(person.Colum5)
      );
      if (hasChild) return;

      // Tìm spouse
      const spouse = rows.find(r => String(r.Colum5) === String(person.Colum6));
      if (!spouse) return;

      const spousePos = Number(spouse.Colum8);
      const personPos = Number(person.Colum8);
      const desiredPos = spousePos + 1;

      // Nếu đã sát nhau thì bỏ qua
      if (personPos === desiredPos) return;

      // Dịch các node nằm giữa spousePos và personPos sang phải 1
      const minPos = Math.min(spousePos, personPos);
      const maxPos = Math.max(spousePos, personPos);

      rows.forEach(r => {
        if (r !== person && Number(r.Colum8) > minPos && Number(r.Colum8) < maxPos) {
          r.Colum8 = Number(r.Colum8) + 1;
        }
      });

      // Đưa person về sát spouse
      person.Colum8 = desiredPos;
    });
  });

  gridOptions.api.setRowData(allData);
  ChinhNamGiuaMeCon2();
}
function ChinhNamGiuaMeCon2() {
    const allData = [];
    gridOptions.api.forEachNode(node => allData.push(node.data));

    // Danh sách đời đã sắp xếp
    const doiList = [...new Set(allData.map(r => parseInt(r.Colum2, 10)))].sort((a, b) => a - b);

    for (let i = 0; i < doiList.length - 1; i++) {
        const doiTren = doiList[i];
        const doiDuoi = doiList[i + 1];

        const groupTren = allData.filter(r => parseInt(r.Colum2, 10) === doiTren);
        const groupDuoi = allData.filter(r => parseInt(r.Colum2, 10) === doiDuoi);

        // Lọc con của đời dưới
        const conDuoi = groupDuoi.filter(r => String(r.Colum7).trim().toLowerCase() === 'con');

        // Gom con theo cha/mẹ ID (Colum6 là tên cha/mẹ)
        const nhomCon = {};
        conDuoi.forEach(child => {
            const parentId = child.Colum6;
            if (!nhomCon[parentId]) nhomCon[parentId] = [];
            nhomCon[parentId].push(child);
        });

        // Căn giữa từng cha/mẹ
        Object.keys(nhomCon).forEach(parentId => {
            const parentRow = groupTren.find(r => r.Colum5 === parentId);
            if (!parentRow) return;

            const sortedKids = nhomCon[parentId].sort((a, b) => a.Colum8 - b.Colum8);
            const firstX = sortedKids[0].Colum8;
            const lastX = sortedKids[sortedKids.length - 1].Colum8;

            // Trung điểm chính xác (cho phép .5)
            const newX = (firstX + lastX) / 2;

            // Tính độ dịch
            const shift = newX - parentRow.Colum8;

            if (shift !== 0) {
                // Chỉ dịch chính cha/mẹ
                parentRow.Colum8 += shift;
            }
        });
    }

    gridOptions.api.setRowData(allData);
}

//====END CÁC HÀM CANH CHỈNH CÂY GIA PHẢ========

//=================================================
//=======NÚT BẤM CẬP NHẬT TỪ FORM VÀO AG===========
 
document.getElementById("confirmUpd").addEventListener("click", function () {
  const { lienHeIDs6, lienHeIDs7 } = layDanhSachLienHeIDs();

  const col14 = document.getElementById("Colum_14");
  const col4 = document.getElementById("Colum_4");

  let colum14Value = col14.value.trim();
  if (colum14Value === "") {
    if (col4.value.trim() === "Nam") {
      colum14Value = "https://cdn-icons-png.flaticon.com/512/1999/1999625.png";
    } else if (col4.value.trim() === "Nữ") {
      colum14Value = "https://cdn-icons-png.flaticon.com/512/194/194938.png";
    }
  }

	const formData = {
	  ID: document.getElementById("ID").value.trim(),
	  Colum2: document.getElementById("Colum_2").value.trim(),
	  Colum3: document.getElementById("Colum_3").value.trim(),
	  Colum4: col4.value.trim(),
	  Colum5: document.getElementById("Colum_5").value.trim(),
	  Colum6: lienHeIDs6.join(", "),
	  Colum7: Array.from(document.querySelectorAll("#tagInput7 .tag")).map(tag => tag.childNodes[0].textContent.trim()).join(", "),
	  Colum8: document.getElementById("Colum_8").value.trim(),
	  Colum9: document.getElementById("Colum_9").value.trim(),
	  Colum10: document.getElementById("Colum_10").value.trim(),
	  Colum11: document.getElementById("Colum_11").value.trim(),
	  Colum12: document.getElementById("Colum_12").value.trim(),
	  Colum13: document.getElementById("Colum_13").value.trim(),
	  Colum14: colum14Value
	};

  // Kiểm tra bắt buộc
  if (!formData.Colum2 || !formData.Colum3 || !formData.Colum4) {
    alert("⚠️ Vui lòng nhập đầy đủ Đời, Họ tên và Giới tính.");
    return;
  }

  let isUpdated = false;

  gridOptions.api.forEachNode(node => {
    if (String(node.data.ID) === formData.ID) {
      UpdateToAg({ ...node.data, ...formData });
		if (node.data.Colum15 !== "themdulieu" && node.data.Colum15 !== "xoadulieu") {
		  node.data.Colum15 = "capnhatdulieu";
		}
      //node.data.Colum15 = "capnhatdulieu";
      isUpdated = true;
	  DanhSoThuTuColum8();
      drawChart();
    }
  });

  if (!isUpdated) {
    InsertToAg(formData);
	DanhSoThuTuColum8();
    drawChart();
  }

  gridOptions.api.refreshCells({ force: true });
  document.getElementById("nhaplieu").reset();
  if (tagify6) tagify6.removeAllTags();
  resetColum7();
});

document.getElementById("confirmDel").addEventListener("click", function () {
  const formData = {
    ID: document.getElementById("ID").value.trim(),
    Colum2: document.getElementById("Colum_2").value.trim(),
    Colum3: document.getElementById("Colum_3").value.trim(),
    Colum5: document.getElementById("Colum_5").value.trim()  // ID cần xóa (từ Colum5)
  };

  // Kiểm tra bắt buộc
  if (!formData.Colum2 || !formData.Colum3 || !formData.Colum5) {
    alert("⚠️ Vui lòng nhập đầy đủ Đời, Họ tên và ID cần xóa.");
    return;
  }

  let isDeleted = false;

  gridOptions.api.forEachNode((node) => {
    // Tìm và xóa dòng có thông tin khớp với formData
    if (
      String(node.data.ID) === formData.ID &&
      String(node.data.Colum2) === formData.Colum2 &&
      node.data.Colum3?.trim() === formData.Colum3 &&
      node.data.Colum5?.trim() === formData.Colum5
    ) {
      // Xóa thông tin chính của người bị xóa
      node.data.Colum2 = "";
      node.data.Colum4 = "";
      node.data.Colum5 = "";
      node.data.Colum6 = "";
      node.data.Colum7 = "";
      node.data.Colum8 = "";
      node.data.Colum15 = "xoadulieu";
      isDeleted = true;
      alert("Đã xóa xong.");
      

      // Xóa các liên kết đến người bị xóa ở Colum6 và Colum7 của Ag
      gridOptions.api.forEachNode((otherNode) => {
        // Nếu Colum6 có chứa ID từ Colum5 của người bị xóa, xóa kết nối trong Colum6 và Colum7
        if (otherNode.data.Colum6?.includes(formData.Colum5)) {
          otherNode.data.Colum6 = otherNode.data.Colum6
            .split(',')
            .map(id => id.trim())
            .filter(id => id !== formData.Colum5)
            .join(', ');  // Xóa ID của người bị xóa khỏi Colum6

          // Tương tự với Colum7
          otherNode.data.Colum7 = ""
        }
      });
	  DanhSoThuTuColum8();
	  drawChart();  
    }
  });

  // Nếu không tìm thấy người cần xóa
  if (!isDeleted) {
    alert("⚠️ Không tìm thấy người cần xóa trong dữ liệu.");
    return;
  }

  // Làm mới grid và form sau khi xóa
  gridOptions.api.refreshCells({ force: true });
  document.getElementById("nhaplieu").reset();
  if (tagify6) tagify6.removeAllTags();
  resetColum7();
});

function layDanhSachLienHeIDs() {
  const lienHeIDs6 = [];
  const lienHeIDs7 = [];

  // Lấy ID từ tagify6
  if (typeof tagify6 !== "undefined" && tagify6.value) {
    tagify6.value.forEach(tag => {
      const tagText = tag.value || tag.display;
      const match = tagText.match(/^(.+?)\s*\(Đời\s*(\d+)\)$/i);
      if (match) {
        const name = match[1].trim();
        const doi = match[2].trim();

        gridOptions.api.forEachNode(node => {
          if (
            node.data.Colum3?.trim() === name &&
            String(node.data.Colum2)?.trim() === doi
          ) {
            lienHeIDs6.push(node.data.Colum5);
          }
        });
      }
    });
  }

  // Lấy ID từ tagInput7
  const tag7Elements = document.querySelectorAll("#tagInput7 .tag");
  tag7Elements.forEach(tag => {
    const tagText = tag.childNodes[0]?.textContent?.trim() || "";
    const match = tagText.match(/^(.+?)\s*\(Đời\s*(\d+)\)$/i);
    if (match) {
      const name = match[1].trim();
      const doi = match[2].trim();

      gridOptions.api.forEachNode(node => {
        if (
          node.data.Colum3?.trim() === name &&
          String(node.data.Colum2)?.trim() === doi
        ) {
          lienHeIDs7.push(node.data.Colum5);
        }
      });
    }
  });

  return { lienHeIDs6, lienHeIDs7 };
}


// 👉 Reset Colum_7 custom tags
function resetColum7() {
  const container = document.getElementById("tagInput7");
  const wrapper = container.closest(".tags-wrapper");
  const input = document.getElementById("Colum_7");

  // Xóa tất cả tag
  container.querySelectorAll(".tag").forEach(tag => tag.remove());

  // Xóa class có tag
  wrapper.classList.remove("has-content");

  // Reset input
  input.value = "";

  // Ẩn dropdown nếu có
  const dropdown = document.getElementById("dropdown7");
  if (dropdown) dropdown.style.display = "none";
}

//=======END NÚT BẤM CẬP NHẬT TỪ FORM VÀO AG===========
  

//-----TEXTAREA FORM NHẬP LIỆU------

document.querySelectorAll('textarea').forEach(textarea => {
  const defaultHeight = '30px'; // đơn vị: px

  // Gọi resize ban đầu nếu có sẵn nội dung
  autoResize(textarea);

  textarea.addEventListener('input', function () {
    autoResize(this);
  });

function autoResize(el) {
  el.style.height = 'auto';

  const scrollHeight = el.scrollHeight;
  const clientHeight = el.clientHeight;

  // Chỉ tăng chiều cao nếu nội dung thực sự tràn
  //if (scrollHeight > clientHeight + 1) {
  if (scrollHeight > clientHeight) {
    el.style.height = scrollHeight + 'px';
  } else {
    el.style.height = '30px'; // giữ nguyên chiều cao mặc định
  }
}

  
});


// 🎯 Lắng nghe sự kiện thay đổi

// ✅ Xử lý click chọn lại giới tính từ dropdown Colum_4
document.querySelectorAll("#dropdown4 div").forEach(item => {
  item.addEventListener("click", function () {
    const value = this.textContent.trim();
    const input = document.getElementById("Colum_4");
    input.value = value;

    // Ẩn dropdown sau khi chọn
    document.getElementById("dropdown4").style.display = "none";

    updateColum6WhitelistOnly(); // ✅ Chỉ update lại whitelist cho Colum_6
  });
});

function updateColum6WhitelistOnly() {
  const doiSo = parseInt(document.getElementById("Colum_2").value.trim());
  const selectedGioiTinh = document.getElementById("Colum_4")?.value.trim();
  const currentID = document.getElementById("ID").value.trim(); // Lấy ID hiện tại

  if (isNaN(doiSo) || !selectedGioiTinh) return;

  const whitelist = [];

  gridOptions.api.forEachNode((node) => {
    const row = node.data;
    if (!row) return;

    // ❌ Loại bỏ chính mình
    if (String(row.ID) === currentID) return;

    const rowDoi = parseInt(row.Colum2);
    const rowGioiTinh = row.Colum4?.trim();
    const rowHasColum7 = row.Colum7 && row.Colum7.trim() !== "";
    const isCloseGeneration = Math.abs(rowDoi - doiSo) <= 1;

    const allow =
      isCloseGeneration &&
      (rowDoi !== doiSo + 1 || !rowHasColum7) &&
      (rowDoi !== doiSo - 1 || row.Colum4 === "Nữ") &&
      (rowDoi !== doiSo || rowGioiTinh !== selectedGioiTinh);

    if (row.Colum3 && allow) {
      whitelist.push({
        value: `${row.Colum3} (Đời ${row.Colum2})`,
        display: `${row.Colum3} (Đời ${row.Colum2})`,
      });
    }
  });

  // ✅ Cập nhật whitelist mà không khởi tạo lại Tagify
  if (tagify6) {
    tagify6.settings.whitelist = whitelist;
    tagify6.dropdown.hide();
    tagify6.dropdown.show.call(tagify6);
  }
}
// ✅ End Xử lý click chọn lại giới tính từ dropdown Colum_4


let tagify3, tagify6;
let debounceTimeout;
let isNewInputInitialized = false;
let currentTagIndex = -1;

// ======= GẮN Tagify cho COLUM_3 =======
// === GẮN DROPDOWN TỰ CHỌN CHO COLUM_3 ===
const inputColum3 = document.getElementById("Colum_3");
const dropdown3 = document.getElementById("dropdown3");
let isFromDropdownSelect = false; // Đánh dấu người dùng có chọn từ dropdown không
const normalize = (str) =>
  str.normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/đ/g, "d").replace(/Đ/g, "D").toLowerCase().trim();


// Gợi ý tên từ Colum_3 khi nhập
inputColum3.addEventListener("input", () => {
  const value = inputColum3.value.trim();
  const doiValue = document.getElementById("Colum_2").value.trim();
  const namePart = normalize(value);

  // ✅ Nếu là chọn từ dropdown thì bỏ qua xử lý reset/sinh ID
  //if (isFromDropdownSelect) {
    //isFromDropdownSelect = true; // reset flag
    //return;
  //}

  // Nếu trống -> reset các cột
  if (value === "") {
    //isFromDropdownSelect = false; // reset flag
    const resetCols = [1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
    resetCols.forEach(i => {
      const el = document.getElementById(`Colum_${i}`);
      if (el) el.value = "";
    });
    document.getElementById("ID").value = "";
    setupColum7TagInput([]);
    autoResizeAllTextarea();
    dropdown3.style.display = "none";
    return;
  }

  // ✅ Trường hợp nhập tay -> sinh ID mới
  const allIDs = new Set();
  gridOptions.api.forEachNode(node => {
    if (node.data?.Colum5) allIDs.add(node.data.Colum5);
  });
  const newID = generateUniqueID(value, doiValue, allIDs);
  document.getElementById("Colum_5").value = newID;

  // Tạo danh sách gợi ý dropdown
  const suggestions = [];
  gridOptions.api.forEachNode(node => {
    const row = node.data;
    if (parseInt(row.Colum2) === parseInt(doiValue)) {
      const name = row.Colum3;
      if (normalize(name).includes(namePart)) {
        suggestions.push(name);
      }
    }
  });

  dropdown3.innerHTML = "";
  suggestions.slice(0, 10).forEach(name => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = name;
    item.addEventListener("click", () => {
      inputColum3.value = name;
      dropdown3.innerHTML = "";
      dropdown3.style.display = "none";
      isFromDropdownSelect = true;
      loadRowDataBydoithu(); // load khi chọn từ dropdown
    });
    dropdown3.appendChild(item);
  });

  dropdown3.style.display = suggestions.length ? "block" : "none";
});

// Ẩn dropdown nếu click ra ngoài
document.addEventListener("click", (e) => {
  if (!inputColum3.contains(e.target) && !dropdown3.contains(e.target)) {
    dropdown3.style.display = "none";
  }
});


// Sự kiện khi thay đổi Đời
document.getElementById("Colum_2").addEventListener("input", () => {
  loadRowDataBydoithu();
});


function loadRowDataBydoithu() {
  const doiInput = document.getElementById("Colum_2");
  const nameInput = document.getElementById("Colum_3");
  const idInput = document.getElementById("Colum_5");
  const doiSo = parseInt(doiInput.value.trim());
  const currentName = nameInput.value.trim();

  const normalize = (str) =>
    str.normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/đ/g, "d").replace(/Đ/g, "D").toLowerCase().trim();
	
  if (isNaN(doiSo) || doiSo < 1) {
    doiInput.value = "1";
    for (let i = 1; i <= 14; i++) {
      const el = document.getElementById(`Colum_${i}`);
      if (el) el.value = "";
    }
    document.getElementById("ID").value = "";
    replaceColum6WithTagify();
    setupColum7TagInput([]);
    autoResizeAllTextarea();
    isNewInputInitialized = false;
    return;
  }

  let trungRow = null;
  const existingIDs = new Set();
  const nameNorm = normalize(currentName);

  gridOptions.api.forEachNode((node) => {
    const row = node.data;
    if (!row) return;
    existingIDs.add(row.Colum5);

    const rowNameNorm = normalize(row.Colum3 || "");
    const rowTenCuoi = rowNameNorm.split(/\s+/).pop();
    const inputTenCuoi = nameNorm.split(/\s+/).pop();

    if (parseInt(row.Colum2) === doiSo && rowTenCuoi === inputTenCuoi) {
      trungRow = row;
    }
  });

  let connectedTags = [];
  let moiLienHeTags = [];
  let newID = generateUniqueID(currentName, doiSo, existingIDs);
  idInput.value = newID;

  if (trungRow) {
    for (let i = 1; i <= 14; i++) {
      const input = document.getElementById(`Colum_${i}`);
      if (input && trungRow[`Colum${i}`] !== undefined) {
        input.value = trungRow[`Colum${i}`];
      }
    }

    document.getElementById("ID").value = trungRow.ID || "";
    idInput.value = trungRow.Colum5 || "";

    // Load Colum_6
    replaceColum6WithTagify();
    //tagify6.addTags(connectedTags);

    // Load Colum_7
    //if (trungRow.Colum6) {
	if (trungRow && isFromDropdownSelect) {
      const idList = trungRow.Colum6.split(",").map(id => id.trim());
      gridOptions.api.forEachNode((node) => {
        const row = node.data;
        if (!row || !row.Colum5) return;
        if (idList.includes(row.Colum5)) {
          const doi = parseInt(row.Colum2);
          const nameWithDoi = `${row.Colum3} (Đời ${doi})`;
          connectedTags.push({ value: nameWithDoi, display: nameWithDoi, doi });
        }
      });

      if (trungRow.Colum7) {
        moiLienHeTags = trungRow.Colum7
          .split(/,|\n/)
          .map(i => i.trim())
          .filter(Boolean);
        document.getElementById("Colum_7").value = "";
      }
    isNewInputInitialized = false;
	}
  } else {
    const resetCols = [1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14];
    resetCols.forEach(i => {
      const el = document.getElementById(`Colum_${i}`);
      if (el) el.value = "";
    });
    document.getElementById("ID").value = "";
	autoResizeAllTextarea();
    isNewInputInitialized = true;
	isFromDropdownSelect = false;
  }

//DANH SÁCH LỌC CHO COLUM_6 NẾU SÓ ĐỜI CHỌN COLUM_2 - 1 (MẸ) THÌ DS NỮ, NẾU COLUM_4 CHỌN NAM THÌ DROPLIST COLUM_6 CHỈ NỮ VÀ NGƯỢC LẠI
const whitelist = [];
gridOptions.api.forEachNode((node) => {
  const row = node.data;
  if (!row) return;

  const rowDoi = parseInt(row.Colum2);
  const rowGioiTinh = row.Colum4?.trim(); // Giới tính của dòng trong lưới
  const selectedGioiTinh = document.getElementById("Colum_4")?.value.trim(); // Giới tính đã chọn

  const rowHasColum7 = row.Colum7 && row.Colum7.trim() !== "";
  const isCloseGeneration = Math.abs(rowDoi - doiSo) <= 1;

  // Lọc theo logic bạn yêu cầu
  const allow =
    isCloseGeneration &&
    (rowDoi !== doiSo + 1 || !rowHasColum7) &&
    (rowDoi !== doiSo - 1 || row.Colum4 === "Nữ") &&
    // Nếu là cùng đời thì phải giới tính khác
    (rowDoi !== doiSo || rowGioiTinh !== selectedGioiTinh);

  if (row.Colum3 && allow) {
    whitelist.push({
      value: `${row.Colum3} (Đời ${row.Colum2})`,
      display: `${row.Colum3} (Đời ${row.Colum2})`,
    });
  }
});



  replaceColum6WithTagify();
  const tagInput6 = document.getElementById("Colum_6");
  tagify6 = new Tagify(tagInput6, {
    enforceWhitelist: true,
    tagTextProp: 'display',
    whitelist: whitelist,
    dropdown: { enabled: 0, maxItems: 100, searchKeys: ["value", "display"] }
  });

  tagify6.removeAllTags();
  document.getElementById("Colum_7").value = "";

  connectedTags.forEach((tag, i) => {
    tagify6.addTags([tag]);
    moiLienHeTags[i] = moiLienHeTags[i] || "";
  });

let isRemovingByCode = false;

tagify6.on("add", (e) => {
  const maxTags = 1; // Giới hạn số Người được add vào Tag Colum_6
  const tagDoi = extractDoi(e.detail.data.display); // Lấy đời từ tag mới thêm
  const index = tagify6.value.length - 1;

  const currentColum2 = parseInt(document.getElementById("Colum_2").value.trim());
  const currentColum3 = document.getElementById("Colum_3").value.trim();

  // ✅ Đếm số tag theo từng đời

if (tagify6.value.length > maxTags) {
  // Lấy các tag đã có trước đó (không tính tag vừa mới thêm)
  const existingTags = tagify6.value.slice(0, maxTags); // Giới hạn số tag hợp lệ
  const tagColum_6 = existingTags.map(tag => tag.display || tag.value).join(', ') || "(không rõ)";

  alert(`❗ Chỉ chọn tối đa ${maxTags} Người liên hệ. "${currentColum3}" đã có mối liên hệ với "${tagColum_6}", nếu muốn sửa đổi thì xóa Người liên hệ cũ và chọn lại.`);

  isRemovingByCode = true;
  tagify6.removeTag(e.detail.data.value); // Xoá tag vừa thêm
  return;
}

  // ❗ Kiểm tra trùng cha/mẹ (giữ nguyên như bạn đang có)
  const hasParentAlready = tagify6.value.slice(0, index).some(tagObj => {
    const tagDoiCheck = extractDoi(tagObj.value || tagObj.display);
    return tagDoiCheck === currentColum2 - 1;
  });

  if (tagDoi === currentColum2 - 1 && hasParentAlready) {
    const chaOrMeTag = tagify6.value.find(tagObj => {
      const tagDoiCheck = extractDoi(tagObj.value || tagObj.display);
      return tagDoiCheck === currentColum2 - 1;
    });

    const chaOrMeName = chaOrMeTag?.display || chaOrMeTag?.value || "(không rõ)";
    const currentColum3Name = document.getElementById("Colum_3").value.trim();
    alert(`❗ "${currentColum3Name}" đã chọn "${chaOrMeName}" là Mẹ rồi, nên không thể thêm.`);
    isRemovingByCode = true;
    tagify6.removeTag(e.detail.data.value);
    return;
  }

  // 🧠 Tự động thêm nếu cùng giới và cùng đời

const tagName = e.detail.data.display || e.detail.data.value || "";
const genderCurrent = document.getElementById("Colum_4")?.value?.trim() || ""; // "Nam" / "Nữ"
const currentColum3Name = document.getElementById("Colum_3")?.value?.trim() || "";

  // ✅ Kiểm tra nếu chưa chọn giới tính thì chặn
  if (!genderCurrent) {
    alert(`❗ Vui lòng chọn giới tính cho "${currentColum3Name}" trước khi chọn Người liên hệ.`);
    isRemovingByCode = true;
    tagify6.removeTag(e.detail.data.value); // ❌ Xoá tag vừa thêm
    return;
  }
  // Tìm row trong grid theo tên và đời
  let tagRowGender = "";
  gridOptions.api.forEachNode(node => {
    const row = node.data;
    if (!row || !row.Colum3 || !row.Colum2) return;
    const tagNameOnly = tagName.replace(/\(Đời.*?\)/g, '').trim();
    if (row.Colum3.trim() === tagNameOnly && parseInt(row.Colum2) === tagDoi) {
      tagRowGender = row.Colum4?.trim() || "";
    }
  });

//ĐOẠN NÀY KHÔNG DÙNG VÌ KHÔNG THỂ XÃY RA DO WHITELIST TRÊN ĐÃ LỌC ĐÚNG  
if (tagDoi === doiSo && genderCurrent && tagRowGender && genderCurrent === tagRowGender) {
  alert(`❗ Chọn Mối liên hệ Vợ/Chồng cho "${currentColum3Name}" có giới tính "${genderCurrent}" chưa đúng với giới tính của "${tagName}"`);
  isRemovingByCode = true;
  tagify6.removeTag(e.detail.data.value); // 👈 xoá tag vừa thêm
  return;
}

  // Nếu không tự động thì show dropdown chọn
  const allowedRelations = getRelationshipByDoi(tagDoi, doiSo);
  updateDropdown7Options([]);

  if (allowedRelations.length === 1) {
    addRelationshipTag(index, allowedRelations[0]);
    moiLienHeTags[index] = allowedRelations[0];
    document.getElementById("dropdown7").style.display = "none";
  } else {
    moiLienHeTags[index] = undefined;
    updateDropdown7Options(allowedRelations);
    currentTagIndex = index;
    document.getElementById("Colum_7").focus();
    document.getElementById("dropdown7").style.display = "block";
  }
});

tagify6.on("remove", (e) => {
  if (isRemovingByCode) {
    isRemovingByCode = false; // reset lại
    return; // bỏ qua xác nhận nếu xóa từ code
  }

  const index = e.detail.index;
  const tagLabel = e.detail.data.display || e.detail.data.value;

  const tag7Container = document.getElementById("tagInput7");
  const tags7 = tag7Container.querySelectorAll(".tag");

  let relationshipText = "";
  if (index >= 0 && index < tags7.length) {
    const relSpan = tags7[index].querySelector("span");
    relationshipText = relSpan?.textContent?.trim() || "";
  }

  const confirmed = confirm(`Bạn có chắc muốn xóa "${tagLabel}" cùng Mối liên hệ "${relationshipText}" ra khỏi danh sách không?`);
  if (!confirmed) {
    tagify6.addTags([e.detail.data]);
    return;
  }

  if (index >= 0 && index < tags7.length) tags7[index].remove();
});



  setupColum7TagInput(moiLienHeTags);
  autoResizeAllTextarea();
}

function extractDoi(displayText) {
  const match = displayText.match(/\(Đời\s*(\d+)\)/);
  return match ? parseInt(match[1]) : null;
}

document.getElementById("Colum_4").addEventListener("input", function () {
  // Lấy lại các giá trị cần thiết
  const doiSo = parseInt(document.getElementById("Colum_2").value.trim());
  const doiLienHe = parseInt(document.getElementById("Colum_6").value.trim());

  if (!isNaN(doiSo) && !isNaN(doiLienHe)) {
    const relationshipList = getRelationshipByDoi(doiLienHe, doiSo);

    // Gọi hàm cập nhật danh sách tag (Colum_7)
    updateColum7Tags(relationshipList);
  }
});

function getRelationshipByDoi(doiLienHe, doiSo) {
  const gender = document.getElementById("Colum_4").value.trim(); // "Nam" hoặc "Nữ"

  if (doiLienHe === doiSo - 1 || doiLienHe === doiSo + 1) {
    return ["Con"];
  }

  if (doiLienHe === doiSo) {
    if (gender === "Nam") return ["Vợ"];
  }
  if (doiLienHe === doiSo) {
    if (gender === "Nữ") return ["Chồng"];
  }
  return [];

}


function updateDropdown7Options(options = []) {
  const dropdown = document.getElementById("dropdown7");
  dropdown.innerHTML = "";
  options.forEach(opt => {
    const div = document.createElement("div");
    div.textContent = opt;
    div.dataset.value = opt;
    dropdown.appendChild(div);
  });
}

function addRelationshipTag(index, text) {
  const container = document.getElementById("tagInput7");
  const input = document.getElementById("Colum_7");

  const tag = document.createElement("div");
  tag.className = "tag";

  const textSpan = document.createElement("span");
  textSpan.textContent = text;

  const close = document.createElement("span");
  close.textContent = "×";
  close.className = "tag-close";

  close.onclick = () => {
    const allTags = Array.from(container.querySelectorAll(".tag"));
    const currentIndex = allTags.indexOf(tag);

    //alert(`📌 Bạn vừa click nút xóa của tag thứ ${currentIndex + 1}`);

    //const confirmed = confirm(`Bạn có chắc muốn xóa mối quan hệ "${textSpan.textContent}" trong Colum_7 và người tương ứng trong Colum_6 không?`);
    //if (!confirmed) return;

    if (tagify6 && tagify6.value.length > currentIndex) {
      const tagToRemove = tagify6.value[currentIndex]?.value;
      isRemovingByColum7 = true;
      tagify6.removeTag(tagToRemove);
      isRemovingByColum7 = false;
    }
  };

  tag.appendChild(textSpan);
  tag.appendChild(close);

  const tags = container.querySelectorAll(".tag");
  if (tags.length > index) {
    tags[index].replaceWith(tag);
  } else {
    container.insertBefore(tag, input);
  }

  const wrapper = container.closest(".tags-wrapper");
  wrapper.classList.add("has-content");
}


function replaceColum6WithTagify() {
  const container = document.getElementById("Colum_6")?.parentElement;
  if (!container) return;
  const current = document.getElementById("Colum_6");
  if (current._tagify) current._tagify.destroy();
  const input = document.createElement("input");
  input.id = "Colum_6";
  input.placeholder = "Chọn người liên hệ";
  container.replaceChild(input, current);
}

//----OK----
function setupColum7TagInput(preSelected = []) {
  const input = document.getElementById("Colum_7");
  const dropdown = document.getElementById("dropdown7");
  const container = document.getElementById("tagInput7");
  const wrapper = container.closest(".tags-wrapper");

  container.querySelectorAll(".tag").forEach(tag => tag.remove());
  wrapper.classList.remove("has-content");

  function addTag(text) {
    const index = container.querySelectorAll(".tag").length;
    addRelationshipTag(index, text);
  }

  function updateHasContentClass() {
    const hasTags = container.querySelectorAll(".tag").length > 0;
    if (hasTags) wrapper.classList.add("has-content");
    else wrapper.classList.remove("has-content");
  }

  input.oninput = () => dropdown.style.display = "block";
  input.onfocus = () => dropdown.style.display = "block";

  dropdown.onclick = (e) => {
    if (e.target && e.target.tagName === "DIV") {
      const selectedValue = e.target.dataset.value || "";
      const tagCount6 = tagify6?.value?.length || 0;
      const tagCount7 = container.querySelectorAll(".tag").length;

      //alert(`📌 Colum_6: ${tagCount6}, Colum_7: ${tagCount7}`);

      if (tagCount7 >= tagCount6) {
        alert("⚠️ Hãy thêm Người liên hệ trước khi chọn Mối liên hệ.");
        return;
      }

      addTag(selectedValue);
      input.value = "";
      dropdown.style.display = "none";
    }
  };

  document.addEventListener("click", (e) => {
    if (!container.contains(e.target)) dropdown.style.display = "none";
  });

  preSelected.forEach(item => addTag(item));
}


// 👉 Lấy dữ liệu Colum_7 khi submit

function getColum7Values() {
  const tags = document.querySelectorAll("#tagInput7 .tag");
  return Array.from(tags).map(tag => tag.childNodes[0].textContent.trim());
}

const tagInput7 = document.getElementById("tagInput7");
const dropdown7 = document.getElementById("dropdown7");

// Hiện dropdown khi focus
tagInput7.addEventListener("focus", () => {
  dropdown7.style.display = "block";
});

// Ẩn dropdown khi click ngoài
document.addEventListener("click", (e) => {
  if (!document.getElementById("Colum_7").contains(e.target)) {
    dropdown7.style.display = "none";
  }
});

// Chọn item trong dropdown => add tag, ẩn dropdown
dropdown7.addEventListener("click", (e) => {
  if (e.target && e.target.tagName === "DIV") {
    const text = e.target.textContent;
    addTagToColum7(text); // Hàm thêm tag bạn có thể tự viết hoặc đã có
    tagInput7.value = "";
    dropdown7.style.display = "none";
  }
});


//--------END XỬ LÝ DROPLITS CHO COLUM_7------------------------

//--------XỬ LÝ DROPLITS CHO COLUM_4------------------------
const colum4Input = document.getElementById("Colum_4");
const dropdown4 = document.getElementById("dropdown4");

// Mở dropdown khi focus hoặc click
colum4Input.addEventListener("focus", () => {
  dropdown4.style.display = "block";
});
colum4Input.addEventListener("click", () => {
  dropdown4.style.display = "block";
});

// Đóng dropdown khi click ra ngoài
document.addEventListener("click", (e) => {
  if (!document.querySelector(".gender-wrapper").contains(e.target)) {
    dropdown4.style.display = "none";
  }
});

// Xử lý chọn giới tính
dropdown4.addEventListener("click", (e) => {
  if (e.target && e.target.tagName === "DIV") {
    colum4Input.value = e.target.textContent;
    dropdown4.style.display = "none";
  }
});

//--------END XỬ LÝ DROPLITS CHO COLUM_4------------------------

// 👉 Hàm tạo ID duy nhất
function generateUniqueID(name, doiSo, existingIDs) {
  // ✅ Nếu chọn từ dropdown thì không sinh ID mới 
  //if (isFromDropdownSelect === true) {
  if (document.getElementById("ID").value.trim() !== "") {
    return document.getElementById("Colum_5").value || ""; // Giữ nguyên ID hiện tại, không tạo id
  }

  const normalize = (str) =>
    str.normalize("NFD")
      .replace(/\p{Diacritic}/gu, "")
      .replace(/đ/g, "d")
      .replace(/Đ/g, "D")
      .toLowerCase()
      .trim();

  const nameNorm = normalize(name);
  const parts = nameNorm.split(/\s+/);
  const initials = parts.map(p => p[0]?.toUpperCase() || '').join('');
  const baseID = `D${doiSo}_${initials}`;
  let finalID = baseID;
  let index = 2;

  while (existingIDs.has(finalID)) {
    finalID = `${baseID}${index}`;
    index++;
  }

  return finalID;
}



// 👉 Auto resize các textarea
function autoResizeAllTextarea() {
  for (let i = 6; i <= 14; i++) {
    const ta = document.getElementById(`Colum_${i}`);
    if (ta && ta.tagName === "TEXTAREA") {
      //ta.style.height = "auto";
      ta.style.height = ta.value.trim() === "" ? "30px" : ta.scrollHeight + "px";
      ta.removeEventListener("input", handleResize);
      ta.addEventListener("input", handleResize);
    }
  }

  function handleResize(e) {
    //e.target.style.height = "auto";
    e.target.style.height = e.target.value.trim() === "" ? "30px" : e.target.scrollHeight + "px";
  }
}

//-----END TEXTAREA FORM NHẬP LIỆU------


//--END FORM NHẬP LIỆU Get dữ liệu dòng Ag vào các Input----




				
//---- VẼ SO ĐỒ GIA PHA D3.JS-----------				
function parseDataFromAgGrid(gridOptions) {
  const rowData = [];
  gridOptions.api.forEachNode(node => {
    if (node.data) rowData.push(node.data);
  });


//===============Header Box==========
document.getElementById("header1").innerHTML = rowData[0].Colum18?.trim();
document.getElementById("header8").innerHTML = rowData[0].Colum25?.trim();
const row = rowData[0];  // Lấy dòng đầu tiên


const boxes = [
  {
    boxId: "box1",
    titleId: "header2",
    contentId: "header3",
    title: row.Colum19?.trim(),
    content: row.Colum20?.trim()
  },
  {
    boxId: "box2",
    titleId: "header4",
    contentId: "header5",
    title: row.Colum21?.trim(),
    content: row.Colum22?.trim()
  },
  {
    boxId: "box3",
    titleId: "header6",
    contentId: "header7",
    title: row.Colum23?.trim(),
    content: row.Colum24?.trim()
  }
];
// Lọc ra những box hợp lệ (title & content không trống)
const validBoxes = boxes.filter(box => box.title && box.content);

// Kiểm tra thiết bị
const isMobilePortrait = window.matchMedia("(max-width: 768px) and (orientation: portrait)").matches;
const isMobileLandscape = window.matchMedia("(max-width: 980px) and (orientation: landscape)").matches;

let width = "100%";

// Nếu KHÔNG phải là điện thoại dọc (tức là PC HOẶC điện thoại ngang)
if (!isMobilePortrait) {
  if (validBoxes.length === 2) width = "50%";
  else if (validBoxes.length === 3) width = "33%";
}


// Ẩn tất cả box trước
boxes.forEach(box => {
  document.getElementById(box.boxId).hidden = true;
});

// Hiển thị box hợp lệ với nội dung và width tương ứng
validBoxes.forEach(box => {
  document.getElementById(box.titleId).innerHTML = box.title;
  document.getElementById(box.contentId).innerHTML = box.content;
  const boxElement = document.getElementById(box.boxId);
  boxElement.style.width = width; // Gán width theo thiết bị
  boxElement.hidden = false;
});


function applyBoxWidths() {
  const isMobilePortrait = window.matchMedia("(max-width: 768px) and (orientation: portrait)").matches;
  let width = "100%";
  if (!isMobilePortrait) {
    if (validBoxes.length === 2) width = "50%";
    else if (validBoxes.length === 3) width = "33%";
  }

  validBoxes.forEach(box => {
    const boxElement = document.getElementById(box.boxId);
    boxElement.style.width = width;
  });
}

window.addEventListener("resize", applyBoxWidths);
applyBoxWidths(); // Gọi ban đầu


//===============End Header Box==========
  
  const id2Label = {};
  rowData.forEach(r => {
    const label = r.Colum3?.trim();
    const idRaw = r.Colum5?.trim();
    if (idRaw) {
      const id = idRaw.toLowerCase();
      id2Label[id] = label || idRaw;
    }
  });

  const nodes = [];
  const links = [];
  const missingLinks = [];
  const xOffsetByY = {};

  rowData.forEach((r, index) => {
    const label = r.Colum3?.trim();
    const idRaw = r.Colum5?.trim();
    if (!idRaw) return;

    const id = idRaw.toLowerCase();
    const toIdsRaw = (r.Colum6 || "").split(/[;,. ]+/).map(s => s.trim()).filter(Boolean);
    const typeList = (r.Colum7 || "").split(/[;,. ]+/).map(s => s.trim()).filter(Boolean);
    const toIds = toIdsRaw.map(x => x.toLowerCase());

    const orderIdx = parseInt(r.Colum8);
    const layer = +r.Colum2 || 1;
    const y = 40 + (layer - 1) * 120;

    let x;
    if (Number.isNaN(orderIdx)) {
      if (!xOffsetByY[y]) xOffsetByY[y] = 10;
      x = xOffsetByY[y];
      xOffsetByY[y] += 250;
    } else {
      x = 20 + (orderIdx - 1) * 250;
    }

    // Vẽ node
    nodes.push({
      id, x, y, label,
      data: {
        birth   : (r.Colum9  || "").trim(),
        hometown: (r.Colum10 || "").trim(),
        married : (r.Colum11 || "").trim(),
        children: (r.Colum12 || "").trim(),
        info    : (r.Colum13 || "").trim(),
        avatar  : (r.Colum14 || "").trim()
      }
    });

    // BỎ QUA kiểm tra missingLinks nếu là dòng đầu tiên
    if (index === 0) return;

    // Giới tính
    const gender = (r.Colum4 || "").toLowerCase();
    const prefix = gender === "nữ" || gender === "nu" ? "Bà" : "Ông";

    // Xử lý tên hiển thị
    let cleanLabel = label || "";
    cleanLabel = cleanLabel.replace(/^ông\s+/i, "").replace(/^bà\s+/i, "");

    const doiText = `Đời ${r.Colum2 || "?"} – ${prefix} ${cleanLabel}`;

    // 1. Cả Colum6 và Colum7 đều rỗng
    if (toIds.length === 0 && typeList.length === 0) {
      missingLinks.push(`“${doiText}” chưa khai báo bất kỳ kết nối nào. Bạn Mở Form để cập nhật lại.`);
      return;
    }

    // 2. Có người liên hệ nhưng không có loại quan hệ
    if (toIds.length > 0 && typeList.length === 0) {
      toIds.forEach(targetId => {
        const targetLabel = id2Label[targetId] || targetId;
        missingLinks.push(`“${doiText}” có liên hệ với “${targetLabel}” nhưng chưa khai báo "Mối quan hệ". Bạn Mở Form để cập nhật lại.`);
      });
      return;
    }

    // 3. Có loại quan hệ nhưng chưa chọn người liên hệ
    if (typeList.length > 0 && toIds.length === 0) {
      typeList.forEach(type => {
        missingLinks.push(`“${doiText}” có Mối quan hệ “${type}” nhưng chưa chọn "Người liên hệ". Bạn Mở Form để cập nhật lại.`);
      });
      return;
    }

    // 4. Có đủ cả toIds và typeList nhưng không khớp
    if (toIds.length > typeList.length) {
      for (let i = typeList.length; i < toIds.length; i++) {
        const targetId = toIds[i];
        const targetLabel = id2Label[targetId] || targetId;
        missingLinks.push(`“${doiText}” <-> “${targetLabel}” thiếu "Mối quan hệ". Bạn Mở Form để cập nhật lại.`);
      }
      return;
    }

    // Tạo liên kết
    const pairCount = Math.min(toIds.length, typeList.length);
    for (let i = 0; i < pairCount; i++) {
      links.push({
        source: id,
        target: toIds[i],
        type  : typeList[i]
      });
    }
  });

  return { nodes, links, missingLinks };
}
document.getElementById("btnRefresh").addEventListener("click", () => {
DanhSoThuTuColum8();
drawChart ();
});


// === 1. Vẽ cây gia phả hoàn chỉnh ===
function drawChart() {
  // ===== 0. Lấy dữ liệu =====
  const { nodes, links, missingLinks } = parseDataFromAgGrid(gridOptions);

  // ===== 1. SVG & layer =====
  const svg = d3.select("#familyTree");
  svg.selectAll("*").remove();
  const zoomLayer = svg.append("g");

  // ===== 2. Hằng số Node =====
  const RECT_W = 230, DEF_H = 90, AVATAR = 40;
  const TOP = 16, BOT = 1, LINE_H = 15, EXTRA_GAP = 1;
  const LEFT_TXT = 10, RIGHT_PAD = 3, CHAR_PX = 5.6;
  const MAX_W_FULL = RECT_W - LEFT_TXT - RIGHT_PAD;

  // ===== 3. Hàm util =====
  const countLines = txt => {
    const [lab, ct = ""] = txt.split(/:(.+)/);
    const words = (lab.trim() + ": " + ct).trim().split(/\s+/);
    let l = "", c = 0;
    words.forEach(w => {
      const t = l + w + " ";
      if (t.length * CHAR_PX > MAX_W_FULL && l !== "") { c++; l = w + " "; }
      else l = t;
    });
    if (l.trim() !== "") c++;
    return c;
  };

  const wrapText = (g, full, y0, maxW = MAX_W_FULL) => {
    const [lab, ct = ""] = full.split(/:(.+)/);
    const bold = lab.trim() + ":";
    const words = ct.trim().split(/\s+/);
    let l = bold + " ", arr = [];
    words.forEach(w => {
      const t = l + w + " ";
      if (t.length * CHAR_PX > maxW && l.trim() !== "") { arr.push(l.trim()); l = w + " "; }
      else l = t;
    });
    if (l.trim() !== "") arr.push(l.trim());

    const text = g.append("text")
      .attr("x", 0).attr("y", y0)
      .attr("font-size", 12)
      .attr("dominant-baseline", "hanging");

    arr.forEach((t, i) => {
      const ts = text.append("tspan").attr("x", 0).attr("y", y0 + i * LINE_H);
      if (i === 0 && t.startsWith(bold)) {
        ts.append("tspan").attr("font-weight", "bold").attr("fill", "#239b56").text(bold + " ");
        ts.append("tspan").attr("fill", "black").text(t.slice(bold.length + 1));
      } else ts.text(t);
    });
    return y0 + arr.length * LINE_H;
  };

  // ===== 4. Tính chiều cao & dồn lớp =====
  const layerMap = {}, wifeRegex = /(vợ|vo|wife|chồng|chong)/i;
  nodes.forEach(n => {
    const block = [`Tên: ${n.label || ""}`, `Sinh: ${n.data.birth || ""}`, `Quê: ${n.data.hometown || ""}`,
      `Kết hôn: ${n.data.married || ""}`, `Con: ${n.data.children || ""}`, `Thông tin: ${n.data.info || ""}`];
    const txtH = block.reduce((s, t) => s + countLines(t) * LINE_H, 0);
    n.height = Math.max(DEF_H, TOP + txtH + BOT);
    (layerMap[n.y] ??= []).push(n);
  });

  let shift = 0;
  Object.keys(layerMap).map(Number).sort((a, b) => a - b).forEach(y => {
    layerMap[y].forEach(n => n.y += shift);
    const hMax = Math.max(...layerMap[y].map(n => n.height));
    if (hMax > DEF_H) shift += hMax - DEF_H + EXTRA_GAP;
  });

  // ===== 5. Xác định node "vợ" =====
  const wifeSet = new Set();
  links.forEach(l => {
    if (wifeRegex.test(l.type || "")) wifeSet.add(l.target);
  });

  /* ===== 6. defs ===== */
  const defs = svg.append("defs");
  // shadow cho box
  defs.append("filter").attr("id","boxShadow")
      .append("feDropShadow").attr("dx",3).attr("dy",3).attr("stdDeviation",3)
      .attr("flood-opacity",.35);
  const grad = defs.append("linearGradient").attr("id","boxGrad");
  grad.append("stop").attr("offset","3%").attr("stop-color","white");
  grad.append("stop").attr("offset","97%").attr("stop-color","white"); //Pha màu cho Content node

/* ===== 6. defs ===== */
// shadow cho tiêu đề
// 1. Tạo gradient chữ inox trắng pha đỏ-đen
const inoxWhiteGrad = defs.append("linearGradient")
  .attr("id", "inoxWhiteGradient")
  .attr("x1", "0%").attr("y1", "0%")
  .attr("x2", "0%").attr("y2", "100%");

inoxWhiteGrad.append("stop").attr("offset", "0%").attr("stop-color", "#ba4a00");
inoxWhiteGrad.append("stop").attr("offset", "20%").attr("stop-color", "#943126");
inoxWhiteGrad.append("stop").attr("offset", "50%").attr("stop-color", "#ffffff");
inoxWhiteGrad.append("stop").attr("offset", "80%").attr("stop-color", "#ba4a00");
inoxWhiteGrad.append("stop").attr("offset", "100%").attr("stop-color", " #e74c3c ");

// 2. Bóng đổ nhẹ tạo hiệu ứng nổi khối (inox 3D)
const filter = defs.append("filter")
  .attr("id", "inoxWhiteShadow")
  .attr("x", "-20%")
  .attr("y", "-20%")
  .attr("width", "150%")
  .attr("height", "150%");

filter.append("feDropShadow")
  .attr("dx", 4)
  .attr("dy", 4)
  .attr("stdDeviation", 2)
  .attr("flood-color", "#f39c12")
  .attr("flood-opacity", 0.9);

  /* ===== 7. CHÚ Ý: VẼ LINK TRƯỚC VẼ NODE ĐỂ ĐƯỜNG NỐI NGANG VỢ/CHỒNG NẰM DƯỚI NODE ===== */
  const linkSel = zoomLayer.selectAll("g.link")
    .data(links).enter().append("g").attr("class","link");  
  // ===== 7. Vẽ node =====
  const nodeSel = zoomLayer.selectAll("g.node")
    .data(nodes).enter().append("g")
    .attr("class", "node")
    .attr("transform", d => `translate(${d.x},${d.y})`);

  nodeSel.append("rect")
    .attr("width", RECT_W).attr("height", d => d.height)
    .attr("fill", "url(#boxGrad)")
    .attr("stroke", "black").attr("stroke-width", 1).attr("filter", "url(#boxShadow)");

  nodeSel.filter(d => wifeSet.has(d.id)).append("line")
    .attr("x1", 0).attr("y1", d => d.height - 1)
    .attr("x2", RECT_W).attr("y2", d => d.height - 1)
    .attr("stroke", "#e74c3c").attr("stroke-width", 1.5);

  nodeSel.append("rect").attr("width", RECT_W).attr("height", 4).attr("fill", "#16a085");
  nodeSel.append("rect")
    .attr("x", RECT_W - AVATAR - 5).attr("y", TOP)
    .attr("width", AVATAR).attr("height", AVATAR)
    .attr("fill", "#fff").attr("stroke", "#cfd8dc");
  nodeSel.append("image")
    .attr("href", d => d.data.avatar || "")
    .attr("x", RECT_W - AVATAR - 5).attr("y", TOP)
    .attr("width", AVATAR).attr("height", AVATAR);

  nodeSel.each(function (d) {
    const g = d3.select(this).append("g").attr("transform", `translate(${LEFT_TXT},${TOP})`);
    let y = 0;
    [`Tên: ${d.label || ""}`, `Sinh: ${d.data.birth || ""}`, `Quê: ${d.data.hometown || ""}`]
      .forEach(t => y = wrapText(g, t, y, RECT_W - AVATAR - 15));
    [`Kết hôn: ${d.data.married || ""}`, `Con: ${d.data.children || ""}`, `Thông tin: ${d.data.info || ""}`]
      .forEach(t => y = wrapText(g, t, y));
  });

  // ===== 8. Gom quan hệ cha - con theo 2 chiều =====
  const parentToChildren = {};
  links.forEach(l => {
    if ((l.type || "").toLowerCase() === "con") {
      const parent = nodes.find(n => n.id === l.source)?.y < nodes.find(n => n.id === l.target)?.y ? l.source : l.target;
      const child = parent === l.source ? l.target : l.source;
      (parentToChildren[parent] ??= []).push(child);
    }
  });

  // ===== 9. Vẽ link =====


  const addedParents = new Set();
  linkSel.each(function (l) {
    const g = d3.select(this);
    const tp = (l.type || "").toLowerCase();

    if (/(vợ|vo|wife|chồng|chong)/.test(tp)) {
      const sN = nodes.find(n => n.id === l.source);
      const tN = nodes.find(n => n.id === l.target);
      if (!sN || !tN) return;
      g.append("line")
        .attr("x1", sN.x + RECT_W).attr("y1", sN.y + DEF_H / 2)
        .attr("x2", tN.x).attr("y2", tN.y + DEF_H / 2)
        .attr("stroke", "red").attr("stroke-width", 0.5);
      return;
    }

    if (tp === "con") {
      const parent = nodes.find(n => n.id === l.source)?.y < nodes.find(n => n.id === l.target)?.y ? l.source : l.target;
      const child = parent === l.source ? l.target : l.source;
      if (addedParents.has(parent)) return;
      addedParents.add(parent);

      const parentNode = nodes.find(n => n.id === parent);
      const childrenNodes = (parentToChildren[parent] || []).map(cid => nodes.find(n => n.id === cid)).filter(Boolean);
      if (!parentNode || childrenNodes.length === 0) return;

      const px = parentNode.x + RECT_W / 2;
      const by = parentNode.y + parentNode.height;
      const midY = Math.min(...childrenNodes.map(k => k.y)) - 15;
      const minX = Math.min(...childrenNodes.map(k => k.x + RECT_W / 2));
      const maxX = Math.max(...childrenNodes.map(k => k.x + RECT_W / 2));

      const add = (x1, y1, x2, y2, col = "#555", w = .8) =>
        g.append("line").attr("x1", x1).attr("y1", y1).attr("x2", x2).attr("y2", y2)
          .attr("stroke", col).attr("stroke-width", w);

      add(px, by, px, midY);
      if (minX !== maxX) {
        if (px < minX) add(px, midY, minX, midY);
        else if (px > maxX) add(px, midY, maxX, midY);
        add(minX, midY, maxX, midY);
      } else {
        add(px, midY, minX, midY);
      }
      childrenNodes.forEach(k => add(k.x + RECT_W / 2, midY, k.x + RECT_W / 2, k.y));
    }
  });



/* ===== 10. Tiêu đề cây ===== */
const maxX = d3.max(nodes, d => d.x + RECT_W);
zoomLayer.append("text")
  .attr("x", maxX / 2)
  .attr("y", 15)  // 👈 tăng khoảng cách trên của chử so với SVG
  .attr("text-anchor", "middle")
  .attr("font-size", 30)
  .attr("font-family", "'Roboto', sans-serif")
  .attr("font-weight", "bold")  // 👈 làm chữ đậm hơn
  .attr("fill", "url(#inoxWhiteGradient)")
  .attr("filter", "url(#inoxWhiteShadow)")
  .style("pointer-events", "none")
  .style("letter-spacing", "2px")
  //.text("GIA PHẢ HỌ LÊ – PHÁI 3 – CHI 1");
  .text(document.getElementById("header8").innerHTML);


// ===== 11. Hover highlight =====

// Gắn lại node object cho link để xử lý hover chính xác
links.forEach(l => {
  if (typeof l.source === 'string') {
    l.sourceNode = nodes.find(n => n.id === l.source);
  } else {
    l.sourceNode = l.source;
    l.source = l.source.id;
  }

  if (typeof l.target === 'string') {
    l.targetNode = nodes.find(n => n.id === l.target);
  } else {
    l.targetNode = l.target;
    l.target = l.target.id;
  }
});

// Xây dựng bảng liên kết hai chiều
const adj = {};
links.forEach(l => {
  const tp = (l.type || "").toLowerCase();
  const a = l.source;
  const b = l.target;

  // Luôn thêm kết nối hai chiều giữa các node
  (adj[a] ??= new Set()).add(b);
  (adj[b] ??= new Set()).add(a);

  // Nếu là "con", kiểm tra vị trí để xác định cha & con
  if (tp === "con") {
    const aNode = nodes.find(n => n.id === a);
    const bNode = nodes.find(n => n.id === b);
    if (aNode && bNode) {
      const parent = aNode.y < bNode.y ? a : b;
      const child = parent === a ? b : a;
      (adj[parent] ??= new Set()).add(child);
      (adj[child] ??= new Set()).add(parent);
    }
  }
});

// Hàm kiểm tra hai node có kết nối không
const isConn = (a, b) => a.id === b.id || adj[a.id]?.has(b.id);

// Gắn sự kiện hover vào node
nodeSel
  .on("mouseover", function(_, d) {
    // Làm mờ node không liên quan
    nodeSel.classed("fade", n => !isConn(d, n));

    // Làm mờ link không kết nối tới node đang hover
    linkSel.classed("fade", l => {
      return !(
        isConn(d, l.sourceNode) || isConn(d, l.targetNode)
      );
    });

    // Đưa node đang hover lên trên
    d3.select(this).raise();
  })
  .on("mouseout", () => {
    nodeSel.classed("fade", false);
    linkSel.classed("fade", false);
  });

	

  /* ===== 12. Zoom / pan ===== */
	// 1. Khởi tạo đối tượng zoom
	const zoom = d3.zoom()
	  .scaleExtent([0.3, 3])
	  .on("zoom", (event) => {
		zoomLayer.attr("transform", event.transform);
	  });
	// 2. Gọi zoom lần đầu
	svg.call(zoom);
	// 3. Đặt transform ban đầu (dịch toàn bộ cây xuống 30px và sang phải 20px)
	const initialTransform = d3.zoomIdentity.translate(20, 30);
	svg.call(zoom.transform, initialTransform);
	// 4. Tự động set kích thước SVG
	const maxY = d3.max(nodes, d => d.y + d.height);
	svg.attr("width", maxX + 50).attr("height", maxY + 50);


  /* ===== 13. Cảnh báo thiếu link ===== */
  if(missingLinks.length){
    requestAnimationFrame(()=>setTimeout(()=>{
      document.getElementById("dialog_ketnoi").style.display="block";
      document.getElementById("id_ketnoi").innerText =
        "Thiếu mối quan hệ:\n"+missingLinks.join("\n");
    },0));
  }
}


// Thoát dialog_ketnoi
document.getElementById("confirm_ketnoi").onclick = function(){show_off_dialog()};
var Thoat_Ketnoi = document.getElementById("confirm_ketnoi");

function show_off_dialog() {
    document.getElementById("dialog_ketnoi").style.display = "none";
}
//---- END VẼ SO ĐỒ HIGHT CHART-----------


		
		//-------- Cập nhật dữ liệu từ Google về của hàm UPDATE và cập nhật vào Ag-----------
		// Danh sách các nút cần thêm sự kiện
		//['confirm_result1', 'confirm_result2', 'confirm_result3'].forEach(id => {
		['id_result1', 'id_result2', 'id_result3'].forEach(id => {
		  document.getElementById(id).addEventListener('click', function () {
			// Ẩn dialog khi bấm nút
			dialog_result.style.display = "none";

			const reUpdate = document.getElementById("ngay").value;

			// Biểu thức chính quy cho các thao tác xóa, cập nhật, và chèn
			const deletePattern = /xoadulieu (\[.*?\])/ig;
			const updatePattern = /capnhatdulieu (\[.*?\])/ig;
			//const updatePattern = /capnhatdulieu (\[.*?\])/ig;
			const insertPattern = /themdulieu (\[.*?\])/ig;

			// Hàm trích xuất dữ liệu từ chuỗi đầu vào
			const extractData = (pattern, dataString) => {
			  const results = [];
			  for (const match of dataString.matchAll(pattern)) {
				//try {
				  results.push(JSON.parse(match[1])); // Parse JSON
				//} catch (error) {
				  //alert("Dữ liệu không đúng định dạng JSON: " + match[1]);
				//}
			  }
			  return results;
			};

			// Trích xuất dữ liệu xóa, cập nhật, và chèn
			const deleteDataArray = extractData(deletePattern, reUpdate);
			const updateDataArray = extractData(updatePattern, reUpdate);
			const insertDataArray = extractData(insertPattern, reUpdate);

			// Gọi hàm xử lý xóa, cập nhật và chèn nếu có dữ liệu
			if (deleteDataArray.length > 0 || updateDataArray.length > 0 || insertDataArray.length > 0) {
			  processExcelData(deleteDataArray, updateDataArray, insertDataArray);
			}
		  });
		});



	
		//-------- End Cập nhật dữ liệu từ Google về của hàm INSERT và cập nhật vào Ag-----------

		//-------- Cập nhật dữ liệu từ Google về của hàm UPLOAD EXCEL và cập nhật vào Ag-----------	

	document.getElementById('confirm_resultExcel').addEventListener('click', function () {
		// Ẩn dialog khi bấm nút
		document.getElementById("dialog_resultExcel").style.display = "none";

		// Lấy dữ liệu từ ô input và loại bỏ khoảng trắng dư thừa
		let output = document.getElementById("output").value.trim();

		// Biểu thức chính quy cho các thao tác xóa, cập nhật, và chèn
		const deletePattern = /xoadulieu (\[.*?\])/ig;
		const updatePattern = /capnhatdulieu (\[.*?\])/ig;
		const insertPattern = /themdulieu (\[.*?\])/ig;

		// Hàm trích xuất dữ liệu từ chuỗi đầu vào
		const extractData = (pattern, dataString) => {
			const results = [];
			for (const match of dataString.matchAll(pattern)) {
				try {
					results.push(JSON.parse(match[1])); // Parse JSON
				} catch (error) {
					alert("Dữ liệu không đúng định dạng");
				}
			}
			return results;
		};

		// Trích xuất dữ liệu xóa, cập nhật, và chèn
		const deleteDataArray = extractData(deletePattern, output);
		const updateDataArray = extractData(updatePattern, output);
		const insertDataArray = extractData(insertPattern, output);

		// Gọi hàm xử lý xóa, cập nhật và chèn
		if (deleteDataArray.length > 0 || updateDataArray.length > 0 || insertDataArray.length > 0) {
			processExcelData(deleteDataArray, updateDataArray, insertDataArray);
		}
	});

//-------- End Cập nhật dữ liệu từ Google về của hàm UPLOAD EXCEL và cập nhật vào Ag-----------	

// HÀM XỬ LÝ XÓA, CẬP NHẬT, THÊM DỮ LIỆU AG
	function processExcelData(deleteDataArray, updateDataArray, insertDataArray) {
		// Xử lý dữ liệu xóa
	if (deleteDataArray.length > 0) {
		let rowsToDelete = []; // Mảng chứa các dòng cần xóa

		gridOptions.api.forEachNode((node, index) => {
			//console.log(`🔍 Kiểm tra hàng ${index + 1} - ID: ${node.data.ID}`); // Debug

			// Duyệt từng phần tử trong deleteDataArray để so sánh ID
			for (let deleteData of deleteDataArray) {
				for (let data of deleteData) {
					//if (node.data && String(node.data.ID) === String(data.ID)) {
					if (node.data && String(node.data.Colum2) === String(data.Colum2)) {
						rowsToDelete.push(node.data); // Thêm vào danh sách xóa
						//console.log(`🗑️ Đánh dấu xóa hàng ${index + 1} - ID: ${data.ID}`);
					}
				}
			}
		});

		if (rowsToDelete.length > 0) {
			// Xóa các dòng trực tiếp khỏi lưới
			gridOptions.api.applyTransaction({ remove: rowsToDelete });

			//alert(`✅ Đã xóa ${rowsToDelete.length} hàng`);

			// Đánh lại số thứ tự sau khi xóa
			setTimeout(() => {
				reindexGrid(); // Đảm bảo chạy sau khi grid đã xóa xong
			}, 0);
		} else {
			//alert("❌ Không tìm thấy hàng nào để xóa.");
		}
	}


		// Xử lý dữ liệu cập nhật
		updateDataArray.forEach(updateData => {
			updateData.forEach(data => {
				UpdateToAg(data); // Gọi hàm cập nhật cho từng hàng
			});
		});

		// Xử lý dữ liệu chèn
		insertDataArray.forEach(insertData => {
			insertData.forEach(data => {
				InsertToAg(data); // Gọi hàm chèn mới cho từng hàng
			});
		});

		// Làm mới giao diện grid
		gridOptions.api.refreshCells({ force: true });
		//alert("Đã xử lý dữ liệu xóa, cập nhật và chèn.");
	}


function DelToAg2(rowsToDelete) {
		gridOptions.api.applyTransaction({ remove: rowsToDelete });

		// Làm mới giao diện ngay lập tức
		gridOptions.api.refreshCells({ force: true });
	}

	function reindexGrid() {
		const allData = [];
		gridOptions.api.forEachNode((node) => {
			allData.push(node.data);
		});

		// Đánh lại số thứ tự (ID) bắt đầu từ 1
		for (let i = 0; i < allData.length; i++) {
			allData[i].ID = i + 1;
		}

		// Cập nhật lại dữ liệu vào grid
		gridOptions.api.setRowData(allData);

		// Làm mới giao diện để hiển thị thay đổi
		setTimeout(function () {
			gridOptions.api.refreshCells({ force: true });
		}, 0);
	}

//========================================================================
			//Update dữ liệu dòng lấy về từ Google về vào Ag
			function UpdateToAg(data) {
				// Tìm dòng dựa trên ID (giả sử ID là chỉ số dòng + 1)
				const rowNode = gridOptions.api.getRowNode(data.ID - 1);

				if (rowNode) {
					// Tạo một bản sao dữ liệu cũ
					const updatedData = { ...rowNode.data };

					// Cập nhật các cột từ Colum2 đến Colum24
					for (let i = 2; i <= 14; i++) {
						const colKey = 'Colum' + i;
						updatedData[colKey] = data[colKey] || '';
					}

					// Cập nhật dữ liệu mới vào dòng
					rowNode.setData(updatedData);

				//} else {
					//alert("Không tìm thấy dòng STT " + data.ID);
				}

				// Làm mới giao diện để hiển thị thay đổi
				setTimeout(function () {
					gridOptions.api.refreshCells({ force: true });
					drawChart(); // Gọi hàm vẽ biểu đồ nếu cần
				}, 0);
			}


				//------End Update dữ liệu dòng lấy về từ Google về vào Ag

			//----- InsertToAg - Thêm dữ liệu dòng mới vào từ Google về vào cuối Ag
			function InsertToAg(data) {
			  let maxID = 0;

			  // Tìm ID lớn nhất hiện có trong toàn bộ grid (kể cả đã lọc)
			  gridOptions.api.forEachNode(node => {
				const id = parseInt(node.data.ID);
				if (!isNaN(id) && id > maxID) {
				  maxID = id;
				}
			  });

			  // Tạo dữ liệu mới
			  let newData = {
				ID: maxID + 1, // Tự động tăng ID
				Colum15: "themdulieu"
			  };

			  // Thêm các cột Colum2 đến Colum14 nếu có
			  for (let i = 2; i <= 14; i++) {
				const colKey = 'Colum' + i;
				newData[colKey] = data[colKey] || '';
			  }

			  // Thêm vào ag-Grid
			  gridOptions.api.applyTransaction({
				add: [newData],
				addIndex: undefined // Không cần chỉ rõ, tự thêm cuối cùng
			  });

			  // Làm mới lưới
			  gridOptions.api.refreshCells({ force: true });

			  // Đảm bảo cập nhật giao diện
			  setTimeout(() => {
				gridOptions.api.refreshCells({ force: true });
			  }, 0);
			}



			//----- End InsertToAg - Thêm dữ liệu dòng mới vào từ Google vào cuối Ag


			//----- End DelToAg - Xóa dòng dữ liệu từ lấy Google trong Ag
			function DelToAg(data) {
			  // Xóa các dòng được chọn
			  gridOptions.api.applyTransaction({ remove: data });

			  // Lấy lại tất cả các dòng sau khi xóa
			  var allData = [];
			  gridOptions.api.forEachNode(function (node) {
				allData.push(node.data);
			  });

			  // Đánh lại STT (ID) cho tất cả các dòng
			  for (var i = 0; i < allData.length; i++) {
				allData[i].ID = i + 1; // STT bắt đầu từ 1
			  }

			  // Nạp lại dữ liệu vào grid sau khi cập nhật STT
			  gridOptions.api.setRowData(allData);

			  // Làm mới bảng
			  gridOptions.api.refreshCells({ force: true });

			}
			//----- End DelToAg - Xóa dòng dữ liệu từ lấy Google trong Ag
//=======================================================================================			
function UpdateToAg2(data) {
		let isUpdated = false;

		// Kiểm tra dữ liệu trong lưới
		gridOptions.api.forEachNode((node, index) => {
			console.log(`Hàng ${index + 1} - ID: ${node.data.ID}`); // Debug ID

			//if (node.data && String(node.data.ID) === String(data.ID)) { 
			if (node.data && String(node.data.Colum2) === String(data.Colum2)) { 
				Object.assign(node.data, data); // Cập nhật dữ liệu vào hàng hiện tại
				isUpdated = true;
				gridOptions.api.refreshCells({ rowNodes: [node] }); // Làm mới hàng sau khi cập nhật
			}
		});

		//if (isUpdated) {
		//	alert(`✅ Đã cập nhật dữ liệu cho ID: ${data.ID}`);
		//} else {
		//	alert(`❌ Không tìm thấy hàng với ID: ${data.ID} để cập nhật.`);
		//}
	}



function InsertToAg2(data) {
    // Kiểm tra nếu node hợp lệ trước khi truy cập `node.data`
    let isNewRow = true; // Mặc định là thêm hàng mới

    gridOptions.api.forEachNode((node) => {
        if (String(node.data.Colum16) === String(data.Colum16)) {
            isNewRow = false; // Nếu tìm thấy dòng có Colum16 trùng, không thêm mới
        }
    });

    if (isNewRow) {
        const rowCount = gridOptions.api.getDisplayedRowCount();
        data.ID = rowCount + 1; // Tạo ID mới dựa trên số lượng hàng hiện tại
        gridOptions.api.applyTransaction({ add: [data] });
        //alert(`Đã chèn dữ liệu mới với ID: ${data.ID}`);
    }
}


//-------- End Cập nhật dữ liệu từ Google về của hàm UPLOAD EXCEL, XÓA, CẬP NHẬT, THÊM và cập nhật vào Ag-----------	

		
			
				//Lấy dữ liệu vào Tecell Row pin khi bấm nút Update, Delete, Insert khi chọn Check box
				document.getElementById('btn-show-update').addEventListener('click', function () {									
									var pinnedRows = gridOptions.api.getPinnedTopRow(0);
									if (pinnedRows) {						
										GetInput(pinnedRows.data);	// Lấy dữ liệu từ Cell row pin vào Textare					
									}
				});	
				document.getElementById('btn-show-delete').addEventListener('click', function () {					
					var pinnedRows = gridOptions.api.getPinnedTopRow(0);
					if (pinnedRows) {						
						GetInput(pinnedRows.data); // Lấy dữ liệu từ Cell row pin vào Textare
					}
				});		
				//Lấy dữ liệu vào Cell Row pin vào Textare khi bấm nút Update, Delete, Insert
				document.getElementById('btn-show-insert').addEventListener('click', function () {
					var pinnedRows = gridOptions.api.getPinnedTopRow(0);
					if (pinnedRows) {
						GetInput(pinnedRows.data); // Lấy dữ liệu từ Cell row pin vào Textare
					}
				});				
				// End Thêm sự kiện cho nút 'btn-show-insert'
				
				// Thêm sự kiện cho nút 'UNHIDE COLUNM'
				//document.getElementById('btn-show-unhide').addEventListener('click', function () {

				function unhideAllColumns() {
					const allColumns = ['ID'];
					for (let i = 2; i <= 24; i++) {
						allColumns.push('Colum' + i);
					}

					// Hiện tất cả các cột
					gridOptions.columnApi.setColumnsVisible(allColumns, true);

					// Khôi phục thứ tự cột về mặc định
					gridOptions.columnApi.resetColumnState();
				}				
				//});

			
				// Thêm sự kiện cho nút 'resetFilterButton'
				document.getElementById('resetFilterButton').addEventListener('click', function () {
					// Xóa dữ liệu của dòng pinned row
					var pinnedRows = gridOptions.api.getPinnedTopRow(0);
					clearInputFields();
				});				
				// End Thêm sự kiện cho nút 'resetFilterButton'

				// Thêm sự kiện cho nút cancel_update để xóa Textarea
				document.getElementById('cancel_update').addEventListener('click', function () {
					clearInputFields2();
				});

				// Thêm sự kiện cho nút cancel_delete để xóa Textarea
				document.getElementById('cancel_delete').addEventListener('click', function () {
					clearInputFields2();
				});

				// Thêm sự kiện cho nút cancel_insert để xóa Textarea
				document.getElementById('cancel_insert').addEventListener('click', function () {
					clearInputFields2();
				});


		},
                sideBar: {
                    toolPanels: [
                        {
                            id: 'columns',
                            labelDefault: 'Columns',
                            labelKey: 'columns',
                            iconKey: 'columns',
                            toolPanel: 'agColumnsToolPanel',
                            toolPanelParams: {
								suppressRowGroups: true,     // ❌ Ẩn phần Row Groups
								suppressValues: true,        // ❌ Ẩn phần Values
								suppressPivots: true,        // ❌ Ẩn phần Pivot
								suppressPivotMode: true      // ❌ Ẩn nút gạt Pivot mode
                            }
                        }
                    ],
                    defaultToolPanel: 'columns',
                    position: 'left',
                    defaultToolPanel: null // Nếu muốn hiển thị Menu khi mở file thì xóa dòng này
                },
                floatingFilter: true,
                isExternalFilterPresent: isExternalFilterPresent, 
                doesExternalFilterPass: doesExternalFilterPass,
				//------------Chọn check box-------------------------
                onSelectionChanged: function(event) {
                    var selectedRows = gridOptions.api.getSelectedRows();
                    if (selectedRows.length > 0) {
                        fillInputFields(selectedRows[0]); //Get dữ liệu cho cell Row pin khi Check box
                    } else {
                        clearInputFields(); // Xóa dữ liệu cell Row pin khi bỏ Check box
                    }
                },
				//------------End Chọn check box-------------------------
                localeText: {
					autosizeThiscolumn: "Điều chỉnh độ rộng cột này",
                    contains: 'Lọc nội dung',
                    notContains: 'Lọc Không chứa nội dung',
                    equals: 'Lọc Bằng',
                    notEqual: 'Lọc Không bằng',
                    startsWith: 'Lọc Bắt đầu với',
                    endsWith: 'Lọc Kết thúc với',
                    blank: 'Lọc Trống',
                    notBlank: 'Lọc Không trống',
                    sortAscending: 'Sắp xếp tăng dần',
                    sortDescending: 'Sắp xếp giảm dần',
                    andCondition: 'và',
                    orCondition: 'hoặc',
                    page: 'tr',
                    of: 'của',
                    size: 'Số',
                    clearSort: 'Bỏ sắp xếp',
                    pinColumn: 'Ghim cột',
					columns: 'Chọn Cột',
                    pinLeft: 'Ghim bên trái',
                    pinRight: 'Ghim bên phải',
                    autosizeAllColumns: 'Điều chỉnh độ rộng tất cả các cột',
                    chooseColumn: 'Chọn cột',
					resetColumns: 'Reset Chọn cột',
                    from: 'Từ',
                    title: 'Tiêu đề',
                    delete: 'Xóa',
                    view: 'Lượt xem',
                    searchOoo: 'Tìm kiếm...',
                    reset: 'Cài đặt lại',
                    loadingOoo: 'Tải...',
                    noPin: 'Hủy ghim',
                    none: 'Không',
                    sum: 'Tổng',
                    min: 'Tối thiểu',
                    max: 'Tối đa',
                    avg: 'Bình thường',
                    count: 'Đếm',
                    filterOoo: 'Bộ lọc...',
                    lessThan: 'Ít hơn',
                    greaterThan: 'Lớn hơn',
                    lessThanOrEqual: 'Ít hơn hoặc bằng',
                    greaterThanOrEqual: 'Lớn hơn hoặc bằng',
                    inRange: 'Trong khoảng',
					copy: 'Sao Chép',
					ctrlC: 'Ctrl+C',
					ctrlX: 'Ctrl+X',
					copyWithHeaders: 'Sao Chép Kèm Tiêu Đề',
					copyWithGroupHeaders: 'Sao Chép Kèm Tiêu Đề Nhóm',
					cut: 'Cắt',
					paste: 'Dán',
					ctrlV: 'Ctrl+V',
					export: 'Xuất',
					csvExport: 'Xuất CSV',
					excelExport: 'Xuất Excel',
					columnFilter: 'Bộ Lọc Cột',
					columnChooser: 'Chọn Cột',
					sortAscending: 'Sắp Xếp Tăng Dần',
					sortDescending: 'Sắp Xếp Giảm Dần',
					sortUnSort: 'Xóa Sắp Xếp'
                }
            };

            var eGridDiv = document.querySelector('#showData');
            eGridDiv.innerHTML = ''; // Xóa nội dung trước đó		
			//------------Tìm kiếm-----------------------------------
		//https://www.ag-grid.com/archive/27.0.0/javascript-data-grid/filter-external/
        var filterText = '';
        function isExternalFilterPresent() {
            return filterText !== '';
        }
        function externalFilterChanged() {
            filterText = document.getElementById('filterText').value;
            gridOptions.api.onFilterChanged();
        }
		function doesExternalFilterPass(node) {
			for (let key in node.data) {
				if (node.data[key] && node.data[key].toString().toLowerCase().includes(filterText.toLowerCase())) {
					return true;
				}
			}
			return false;
		}




		// Hàm tìm kiếm
		function highlightSearchText(params) {
			var cellValue = params.value ? params.value.toString() : '';
			var searchValue = document.getElementById('filterText').value.toUpperCase();
			var matchCount = 0; // Biến đếm số lần xuất hiện trong mỗi ô

			if (!searchValue || searchValue === '') {
				return cellValue;
			}

			var index = cellValue.toUpperCase().indexOf(searchValue);

			if (index >= 0) {
				var highlightedText = '';
				while (index >= 0) {
					matchCount++;
					highlightedText += cellValue.substring(0, index) +
						'<span class="highlight">' + cellValue.substring(index, index + searchValue.length) + '</span>';
					cellValue = cellValue.substring(index + searchValue.length);
					index = cellValue.toUpperCase().indexOf(searchValue);
				}
				highlightedText += cellValue; // Thêm phần còn lại của ô sau khi đã tìm kiếm
				return highlightedText;
			}
			return cellValue;
		}

		// Thêm sự kiện input cho ô tìm kiếm
		document.getElementById('filterText').addEventListener('input', function() {
			var searchText = this.value.toUpperCase();
			gridOptions.api.setQuickFilter(searchText);

			// Thực hiện tô màu lại sau khi thay đổi giá trị tìm kiếm
			setTimeout(function() {
				gridOptions.api.refreshCells({ force: true });
			}, 0);

			updateCount();
		});


		// Hàm cập nhật số lượng kết quả tìm kiếm
		function updateCount() {
			var searchValue = document.getElementById('filterText').value.toUpperCase();
			var totalMatches = 0;
			var totalStringMatches = 0;

			gridOptions.api.forEachNode(function(node) {
				var rowMatched = false;
				for (var key in node.data) {
					if (node.data.hasOwnProperty(key)) {
						var cellValue = node.data[key] ? node.data[key].toString().toUpperCase() : '';
						if (cellValue.indexOf(searchValue) >= 0) {
							rowMatched = true;
							totalStringMatches++;
						}
					}
				}
				if (rowMatched) {
					totalMatches++;
				}
			});

			if (searchValue) {
				document.getElementById('count').innerText = totalMatches + ' dòng, ' + totalStringMatches + ' Kq';
			} else {
				document.getElementById('count').innerText = '';
			}
		}		
		
		//------------End Tìm kiếm-----------------------------------

		//---------------Row pin-----------------

		function getValue(params) {
                if (params.node.rowPinned) {
                    return pinnedRowData[0][params.colDef.field] || '';
                }
                return params.data[params.colDef.field];
            }

            function setValue(params) {
                if (params.node.rowPinned) {
                    pinnedRowData[0][params.colDef.field] = params.newValue;
                    return true;
                }
                return false;
            }

			function fillInputFields(data) { // Get dữ liệu cho cell Row pin khi Check box
				if (Array.isArray(pinnedRowData) && pinnedRowData.length > 0) {
					// Cập nhật dữ liệu cho hàng ghim
					pinnedRowData[0].ID = data.ID || '';
					for (let i = 2; i <= 24; i++) {
						pinnedRowData[0]['Colum' + i] = data['Colum' + i] || '';
					}

					// Cập nhật lại dữ liệu trong bảng
					setTimeout(function() {
						gridOptions.api.refreshCells({ force: true });
					}, 0);
				}
			}


			function clearInputFields() {  // Xóa dữ liệu cell Row pin khi bỏ Check box
				if (Array.isArray(pinnedRowData) && pinnedRowData.length > 0) {
					pinnedRowData[0].ID = '';
					for (let i = 2; i <= 24; i++) {
						pinnedRowData[0]['Colum' + i] = '';
					}

					// Cập nhật lại dữ liệu trong bảng
					setTimeout(function() {
						gridOptions.api.refreshCells({ force: true });
						clearInputFields2();  // Xóa dữ liệu Textarea khi bỏ Check box
					}, 0);
				}
			}
		
		//---------------End Row pin-----------------
		//---------------Get Textarea từ Row pin-----------------

			function GetInput(data) {   // Lấy ID từ cell Row pin vào Textarea khi bấm nút Update, Delete, Thêm
				// Đóng Textarea Pinrow
				if (gridOptions.api) {
					gridOptions.api.stopEditing();
				}

				// Lấy dữ liệu từ cell Row pin vào Textarea
				if (Array.isArray(pinnedRowData) && pinnedRowData.length > 0) {
					document.getElementById('id').value = data.ID || '';
					for (let i = 2; i <= 24; i++) {
						const colId = 'Colum' + i;
						const textarea = document.getElementById(colId);
						if (textarea) {
							textarea.value = pinnedRowData[0][colId] || '';
						}
					}

					// Cập nhật lại dữ liệu trong bảng
					setTimeout(function() {
						gridOptions.api.refreshCells({ force: true });
					}, 0);
				}
			}
		


			
		var eGridDiv = document.querySelector('#showData');
            new agGrid.Grid(eGridDiv, gridOptions);

            document.getElementById("spinner").style.display = "none"; // Ẩn spinner khi dữ liệu đã tải xong
            document.getElementById('filterText').addEventListener('input', externalFilterChanged);
			
		//---- Tính năng thay đổi độ cao dòng-----------
		var gridOptions;		
				var startY, startHeight, currentRowIndex;

				document.addEventListener('mousedown', function(event) {
					if (event.target.classList.contains('ag-row-resize-handle')) {
						startY = event.clientY;
						currentRowIndex = event.target.parentElement.getAttribute('row-index');
						startHeight = gridOptions.api.getRowNode(currentRowIndex).rowHeight;
						document.addEventListener('mousemove', onMouseMove);
						document.addEventListener('mouseup', onMouseUp);
					}
				});

				function onMouseMove(event) {
					var newHeight = startHeight + (event.clientY - startY);
					if (newHeight > 20) { // Đảm bảo chiều cao tối thiểu là 20px
						gridOptions.api.getRowNode(currentRowIndex).setRowHeight(newHeight);
						gridOptions.api.onRowHeightChanged();
					}
				}

				function onMouseUp() {
					document.removeEventListener('mousemove', onMouseMove);
					document.removeEventListener('mouseup', onMouseUp);
				}

				function createResizeHandle() {
					var resizeHandle = document.createElement('div');
					resizeHandle.className = 'ag-row-resize-handle';
					return resizeHandle;
				}

				function addResizeHandles() {
					var rows = document.querySelectorAll('.ag-row');
					rows.forEach(function(row) {
						if (!row.querySelector('.ag-row-resize-handle')) {
							row.appendChild(createResizeHandle());
						}
					});
				}
				addResizeHandles();
			//---- End Tính năng thay đổi độ cao dòng-----------
	
			//---------- Hàm để xuất dữ liệu ra Excel-----------
document.getElementById('exp').addEventListener('change', function() {
    var expSelect = document.getElementById('exp');
    var selectedOption = expSelect.value;

    if (selectedOption === 'exp1') {
        gridOptions.api.exportDataAsExcel();
        expSelect.value = 'Excel'; // Đặt lại giá trị về 'Excel'
    } else if (selectedOption === 'exp2') {
        exportToExcel(gridOptions, columnDefs);
        expSelect.value = 'Excel'; // Đặt lại giá trị về 'Excel'
    } else if (selectedOption === 'exp3') {
        exportTemplateExcel(columnDefs); // Xuất mẫu Excel
        expSelect.value = 'Excel'; // Đặt lại giá trị về 'Excel'
    }
});

// Hàm xuất dữ liệu Excel đầy đủ
async function exportToExcel(gridOptions, columnDefs) {
    try {
        const workbook = new ExcelJS.Workbook();

        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        const formattedDate = `${day}.${month}.${year}`;

        const sheetName = `VT_VoTuyen_${formattedDate}`;
        const worksheet = workbook.addWorksheet(sheetName);

        const header = columnDefs.map(colDef => colDef.headerName);
        worksheet.addRow(header);

        gridOptions.api.forEachNodeAfterFilter(node => {
            const row = columnDefs.map(colDef => node.data[colDef.field]);
            worksheet.addRow(row);
        });

        worksheet.getColumn(1).alignment = { horizontal: 'center', vertical: 'middle' };

        worksheet.eachRow({ includeEmpty: true }, function(row) {
            row.eachCell({ includeEmpty: true }, function(cell) {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                cell.font = { name: 'Times New Roman' };
            });
        });

        const headerRow = worksheet.getRow(1);
        headerRow.eachCell({ includeEmpty: true }, function(cell) {
            cell.font = { name: 'Times New Roman', bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFB2DFFB' }
            };
        });

        const filename = `${sheetName}.xlsx`;
        const buffer = await workbook.xlsx.writeBuffer();

        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIPhone = /iPhone/.test(navigator.userAgent);

        if (isSafari && isIPhone) {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, filename);
        } else {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

    } catch (error) {
        console.error('Có lỗi xảy ra khi xuất dữ liệu:', error);
    }
}

// Hàm xuất mẫu Excel (chỉ dòng tiêu đề và dòng với giá trị 'Temp', cell đầu tiên là 1)
async function exportTemplateExcel(columnDefs) {
    try {
        const workbook = new ExcelJS.Workbook();

        const sheetName = `MauExcel_Upload`;
        const worksheet = workbook.addWorksheet(sheetName);

        // Thêm dòng tiêu đề
        const header = columnDefs.map(colDef => colDef.headerName);
        worksheet.addRow(header);

        // Thêm dòng thứ 2 với cell đầu tiên là '1' và các cell còn lại là 'Temp'
        const tempRow = columnDefs.map((_, index) => (index === 0 ? 1 : 'Temp'));
        worksheet.addRow(tempRow);

        // Định dạng các cell
        worksheet.eachRow({ includeEmpty: true }, function(row) {
            row.eachCell({ includeEmpty: true }, function(cell) {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
                cell.font = { name: 'Times New Roman' };
            });
        });

        const headerRow = worksheet.getRow(1);
        headerRow.eachCell({ includeEmpty: true }, function(cell) {
            cell.font = { name: 'Times New Roman', bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.fill = {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFB2DFFB' }
            };
        });

        const filename = `${sheetName}.xlsx`;
        const buffer = await workbook.xlsx.writeBuffer();

        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIPhone = /iPhone/.test(navigator.userAgent);

        if (isSafari && isIPhone) {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, filename);
        } else {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
        }

    } catch (error) {
        console.error('Có lỗi xảy ra khi xuất mẫu Excel:', error);
    }
}


			//----------End Hàm để xuất dữ liệu ra Excel-----------
		
        });
    }
}




$(function(){
      $(".HorizontalTable").scroll(function(){
        $(".ag-body-horizontal-scroll-viewport").scrollLeft($(".HorizontalTable").scrollLeft());
      });
      $(".ag-body-horizontal-scroll-viewport").scroll(function(){
        $(".HorizontalTable").scrollLeft($(".ag-body-horizontal-scroll-viewport").scrollLeft());
      });
});	


function clearInputFields2() { // Xóa dữ liệu Textarea
    document.getElementById('id').value = '';
    for (let i = 2; i <= 24; i++) {
        const colId = 'Colum' + i;
        const textarea = document.getElementById(colId);
        if (textarea) {
            textarea.value = '';
        }
    }
}



</script>

<div class="footer">
<div class="footer-middle">
  <div class="footer-col first">
    <div class="footer-item">
      <i class="fa fa-map-marker"></i>
      <span>Website: Cây gia phả: Họ Lê - Phái 3 - Chi 1, Thôn An lợi, Triệu Độ, Triệu Phong, Quảng Trị.</span>
    </div>
  </div>

  <div class="footer-col">
    <div class="footer-item">
      <i class="fa fa-envelope"></i>
      <a href="mailto:khanhvtn@gmail.com">khanhvtn@gmail.com</a>
    </div>
  </div>
</div>

  <div class="footer-bottom">
    <p class="copyright">Copyright © 2025 By: Lê Văn Khanh. All rights reserved.</p>
  </div>
  
</div>  

</body>
</html>
